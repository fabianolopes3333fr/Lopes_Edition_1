{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6 mb-10">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fas fa-cog text-blue-600"></i>
            Paramètres du compte
        </h1>
        <p class="mt-2 text-gray-600">Gérez vos préférences et paramètres de sécurité</p>
    </div>

    <!-- Messages (dinâmico via JS) -->
    <div id="message-container" class="mb-6 hidden">
        <div id="message" class="px-4 py-3 rounded-lg text-sm font-medium"></div>
    </div>

    <!-- Notifications Settings -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
        <div class="p-6">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-bell text-blue-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">Notifications</h2>
            </div>
            <form id="preferences-form">
                {% csrf_token %}
                <!-- Item -->
                <div class="py-4 flex items-start justify-between gap-6 border-t first:border-t-0 border-gray-100">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">Notifications par email</h3>
                        <p class="text-sm text-gray-500">Recevoir les mises à jour importantes par email</p>
                    </div>
                    <button type="button" class="toggle-switch relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 {% if user.profile.notifications_email %}bg-blue-600{% else %}bg-gray-300{% endif %}" data-field="email_notifications">
                        <span class="sr-only">Toggle email notifications</span>
                        <span class="indicator inline-block h-5 w-5 transform rounded-full bg-white shadow transition {% if user.profile.notifications_email %}translate-x-5{% else %}translate-x-1{% endif %}"></span>
                        <input type="checkbox" name="email_notifications" {% if user.profile.notifications_email %}checked{% endif %} hidden>
                    </button>
                </div>
                <!-- Item -->
                <div class="py-4 flex items-start justify-between gap-6 border-t border-gray-100">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">Newsletter</h3>
                        <p class="text-sm text-gray-500">Recevoir les offres spéciales et actualités</p>
                    </div>
                    <button type="button" class="toggle-switch relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 {% if user.profile.newsletter %}bg-blue-600{% else %}bg-gray-300{% endif %}" data-field="newsletter">
                        <span class="sr-only">Toggle newsletter</span>
                        <span class="indicator inline-block h-5 w-5 transform rounded-full bg-white shadow transition {% if user.profile.newsletter %}translate-x-5{% else %}translate-x-1{% endif %}"></span>
                        <input type="checkbox" name="newsletter" {% if user.profile.newsletter %}checked{% endif %} hidden>
                    </button>
                </div>
                <!-- Item -->
                <div class="py-4 flex items-start justify-between gap-6 border-t border-gray-100">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">Notifications de projets</h3>
                        <p class="text-sm text-gray-500">Recevoir les mises à jour sur vos projets</p>
                    </div>
                    <button type="button" class="toggle-switch relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 {% if user.profile.project_notifications %}bg-blue-600{% else %}bg-gray-300{% endif %}" data-field="project_notifications">
                        <span class="sr-only">Toggle project notifications</span>
                        <span class="indicator inline-block h-5 w-5 transform rounded-full bg-white shadow transition {% if user.profile.project_notifications %}translate-x-5{% else %}translate-x-1{% endif %}"></span>
                        <input type="checkbox" name="project_notifications" {% if user.profile.project_notifications %}checked{% endif %} hidden>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
        <div class="p-6">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-shield-alt text-green-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">Sécurité</h2>
            </div>
            <div class="py-4 flex items-start justify-between gap-6 border-t first:border-t-0 border-gray-100">
                <div class="flex-1">
                    <h3 class="font-medium text-gray-900">Authentification à deux facteurs</h3>
                    <p class="text-sm text-gray-500">Ajouter une couche de sécurité supplémentaire</p>
                </div>
                <button type="button" id="2fa-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 {% if user.profile.two_factor_enabled %}bg-green-600{% else %}bg-gray-300{% endif %}">
                    <span class="sr-only">Toggle 2FA</span>
                    <span class="indicator inline-block h-5 w-5 transform rounded-full bg-white shadow transition {% if user.profile.two_factor_enabled %}translate-x-5{% else %}translate-x-1{% endif %}"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Privacy Settings -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
        <div class="p-6">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-user-lock text-purple-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">Confidentialité</h2>
            </div>
            <div class="py-4 border-t first:border-t-0 border-gray-100">
                <h3 class="font-medium text-gray-900">Consentement de traitement des données</h3>
                <p class="text-sm text-gray-500">Statut: <span class="font-medium {% if user.profile.data_processing_consent %}text-green-600{% else %}text-red-600{% endif %}">{{ user.profile.data_processing_consent|yesno:"Accordé,Refusé" }}</span></p>
            </div>
            <div class="py-4 border-t border-gray-100">
                <h3 class="font-medium text-gray-900">Consentement marketing</h3>
                <p class="text-sm text-gray-500">Statut: <span class="font-medium {% if user.profile.marketing_consent %}text-green-600{% else %}text-red-600{% endif %}">{{ user.profile.marketing_consent|yesno:"Accordé,Refusé" }}</span></p>
            </div>
        </div>
    </div>

    <!-- Data Management -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
        <div class="p-6">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-database text-indigo-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">Gestion des données</h2>
            </div>
            <div class="py-4 flex items-start justify-between gap-6 border-t first:border-t-0 border-gray-100">
                <div class="flex-1">
                    <h3 class="font-medium text-gray-900">Exporter mes données</h3>
                    <p class="text-sm text-gray-500">Télécharger une copie de toutes vos données</p>
                </div>
                <button id="export-data-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                    Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-white rounded-lg shadow-sm border-2 border-red-200 mb-4">
        <div class="p-6">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-red-600">Zone de danger</h2>
            </div>
            <div class="py-4 flex items-start justify-between gap-6 border-t first:border-t-0 border-gray-100">
                <div class="flex-1">
                    <h3 class="font-medium text-red-900">Supprimer le compte</h3>
                    <p class="text-sm text-red-700">Action irréversible. Toutes vos données seront supprimées.</p>
                </div>
                <button id="delete-account-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                    Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6 shadow-xl border border-gray-200">
            <div class="flex items-center mb-4 gap-3">
                <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
                <h3 class="text-lg font-semibold text-red-600">Confirmer la suppression</h3>
            </div>
            <p class="text-gray-700 mb-6 text-sm leading-relaxed">Êtes-vous sûr de vouloir supprimer définitivement votre compte ? Cette action ne peut pas être annulée.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete" class="px-4 py-2 text-gray-600 hover:text-gray-800 text-sm font-medium">Annuler</button>
                <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Supprimer définitivement</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('message-container');
    const messageElement = document.getElementById('message');

    function showMessage(text, type = 'success') {
        messageElement.textContent = text;
        messageElement.className = 'px-4 py-3 rounded-lg text-sm font-medium ' + (type === 'success'
            ? 'bg-green-50 text-green-800 border border-green-300'
            : 'bg-red-50 text-red-800 border border-red-300');
        messageContainer.classList.remove('hidden');
        setTimeout(() => messageContainer.classList.add('hidden'), 4500);
    }

    // Toggle switches (preferences)
    document.querySelectorAll('.toggle-switch[data-field]').forEach(btn => {
        btn.addEventListener('click', function() {
            const checkbox = this.querySelector('input[type="checkbox"]');
            const active = checkbox.checked;
            checkbox.checked = !active;
            // UI update
            this.classList.toggle('bg-blue-600', checkbox.checked);
            this.classList.toggle('bg-gray-300', !checkbox.checked);
            const indicator = this.querySelector('.indicator');
            indicator.classList.toggle('translate-x-5', checkbox.checked);
            indicator.classList.toggle('translate-x-1', !checkbox.checked);

            const formData = new FormData(document.getElementById('preferences-form'));
            fetch('{% url "accounts:update_preferences" %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                    // revert
                    checkbox.checked = active;
                    this.classList.toggle('bg-blue-600', checkbox.checked);
                    this.classList.toggle('bg-gray-300', !checkbox.checked);
                    indicator.classList.toggle('translate-x-5', checkbox.checked);
                    indicator.classList.toggle('translate-x-1', !checkbox.checked);
                }
            })
            .catch(() => {
                showMessage('Erreur de connexion', 'error');
                checkbox.checked = active;
                this.classList.toggle('bg-blue-600', checkbox.checked);
                this.classList.toggle('bg-gray-300', !checkbox.checked);
                indicator.classList.toggle('translate-x-5', checkbox.checked);
                indicator.classList.toggle('translate-x-1', !checkbox.checked);
            });
        });
    });

    // 2FA toggle
    const twoFA = document.getElementById('2fa-toggle');
    if (twoFA) {
        twoFA.addEventListener('click', function() {
            const enabled = this.classList.contains('bg-green-600') ? 0 : 1;
            fetch('{% url "accounts:toggle_2fa" %}', {
                method: 'POST',
                body: JSON.stringify({ enabled: !!enabled }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('bg-green-600', !!enabled);
                    this.classList.toggle('bg-gray-300', !enabled);
                    const indicator = this.querySelector('.indicator');
                    indicator.classList.toggle('translate-x-5', !!enabled);
                    indicator.classList.toggle('translate-x-1', !enabled);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(() => showMessage('Erreur de connexion', 'error'));
        });
    }

    // Export data
    const exportBtn = document.getElementById('export-data-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const original = this.textContent;
            this.disabled = true; this.textContent = 'Export...';
            fetch('{% url "accounts:export_data" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
            })
            .then(r => { if (r.ok) return r.blob(); throw new Error(); })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `dados_lopes_peinture_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                showMessage('Export réalisé avec succès!', 'success');
            })
            .catch(() => showMessage("Erreur lors de l'export", 'error'))
            .finally(() => { this.disabled = false; this.textContent = original; });
        });
    }

    // Delete account modal
    const deleteModal = document.getElementById('delete-modal');
    const deleteBtn = document.getElementById('delete-account-btn');
    const cancelBtn = document.getElementById('cancel-delete');
    const confirmBtn = document.getElementById('confirm-delete');

    if (deleteBtn) deleteBtn.addEventListener('click', () => deleteModal.classList.remove('hidden'));
    if (cancelBtn) cancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));

    if (confirmBtn) confirmBtn.addEventListener('click', function() {
        const original = this.textContent;
        this.disabled = true; this.textContent = 'Suppression...';
        fetch('{% url "accounts:delete_account" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => window.location.href='/', 1700);
            } else {
                showMessage(data.message, 'error');
                this.disabled = false; this.textContent = original;
            }
        })
        .catch(() => { showMessage('Erreur lors de la suppression', 'error'); this.disabled = false; this.textContent = original; });
    });

    // Close modal clicking outside
    deleteModal.addEventListener('click', e => { if (e.target === deleteModal) deleteModal.classList.add('hidden'); });
});
</script>
{% endblock %}
