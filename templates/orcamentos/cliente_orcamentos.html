{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Mes Devis - LOPES PEINTURE{% endblock %}

{% block content %}
{% csrf_token %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-file-invoice-dollar text-white text-xl"></i>
                </div>
                Mes Devis
            </h1>
            <p class="text-gray-600 mt-2 text-lg">
                Consultez vos demandes de devis et orçaments reçus
            </p>
        </div>

        <a href="{% url 'orcamentos:solicitar_publico' %}"
           class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-xl font-semibold shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 flex items-center gap-3">
            <i class="fas fa-plus"></i>
            Nouvelle Demande
        </a>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-2">
        <div class="flex space-x-2">
            <button class="tab-button active px-6 py-3 rounded-xl font-semibold transition-all duration-300" data-tab="solicitacoes">
                Mes Demandes
            </button>
            <button class="tab-button px-6 py-3 rounded-xl font-semibold transition-all duration-300" data-tab="orcamentos">
                Devis Reçus
            </button>
        </div>
    </div>

    <!-- Solicitações Tab -->
    <div id="solicitacoes-tab" class="tab-content">
        {% if solicitacoes %}
            <div class="grid grid-cols-1 gap-6">
                {% for solicitacao in solicitacoes %}
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                        <div class="flex flex-col lg:flex-row justify-between items-start gap-6">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-4">
                                    <h3 class="text-xl font-bold text-gray-900">#{{ solicitacao.numero }}</h3>
                                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-md
                                        {% if solicitacao.status == 'pendente' %}bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800
                                        {% elif solicitacao.status == 'em_elaboracao' %}bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800
                                        {% elif solicitacao.status == 'enviado' %}bg-gradient-to-r from-green-100 to-green-200 text-green-800
                                        {% elif solicitacao.status == 'aceito' %}bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-800
                                        {% else %}bg-gradient-to-r from-red-100 to-red-200 text-red-800{% endif %}">
                                        {{ solicitacao.get_status_display }}
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                    <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-tag text-blue-600"></i>
                                        <span class="font-medium">{{ solicitacao.get_tipo_servico_display }}</span>
                                    </div>

                                    <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-map-marker-alt text-green-600"></i>
                                        <span class="font-medium">{{ solicitacao.cidade }}</span>
                                    </div>

                                    <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-calendar text-orange-600"></i>
                                        <span class="font-medium">{{ solicitacao.created_at|date:"d/m/Y" }}</span>
                                    </div>
                                </div>

                                {% if solicitacao.projeto %}
                                <div class="mb-4">
                                    <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                        <i class="fas fa-link"></i>
                                        Projet: {{ solicitacao.projeto.titulo }}
                                    </span>
                                </div>
                                {% endif %}

                                <p class="text-gray-700 leading-relaxed">
                                    {{ solicitacao.descricao_servico|truncatewords:30 }}
                                </p>
                            </div>

                            <div class="flex flex-col items-end gap-3">
                                {% if solicitacao.orcamento %}
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Devis disponible</div>
                                        <div class="text-2xl font-bold text-green-600">€{{ solicitacao.orcamento.total }}</div>
                                    </div>
                                {% endif %}

                                <div class="flex gap-2">
                                    {% if solicitacao.projeto %}
                                        <a href="{% url 'orcamentos:cliente_projeto_detail' solicitacao.projeto.uuid %}"
                                           class="px-4 py-2 border-2 border-blue-600 text-blue-600 hover:bg-blue-50 rounded-lg text-sm font-semibold transition-all duration-200">
                                            Voir projet
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-32 h-32 bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-file-invoice-dollar text-yellow-600 text-4xl"></i>
                </div>

                <h3 class="text-2xl font-bold text-gray-900 mb-4">
                    Aucune demande de devis
                </h3>

                <p class="text-gray-600 mb-8 max-w-md mx-auto leading-relaxed">
                    Vous n'avez pas encore fait de demande de devis. Créez un projet ou demandez directement un devis.
                </p>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="{% url 'orcamentos:cliente_criar_projeto' %}"
                       class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-semibold shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3">
                        <i class="fas fa-plus"></i>
                        Créer un projet
                    </a>

                    <a href="{% url 'orcamentos:solicitar_publico' %}"
                       class="px-8 py-4 border-2 border-gray-300 hover:border-green-500 text-gray-700 hover:text-green-600 rounded-xl font-semibold transition-all duration-300 hover:bg-green-50 flex items-center justify-center gap-3">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Demander un devis
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Orçamentos Tab -->
    <div id="orcamentos-tab" class="tab-content hidden">
        {% if orcamentos %}
            <div class="grid grid-cols-1 gap-6">
                {% for orcamento in orcamentos %}
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                        <div class="flex flex-col lg:flex-row justify-between items-start gap-6">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-4">
                                    <h3 class="text-xl font-bold text-gray-900">Devis #{{ orcamento.numero }}</h3>
                                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold shadow-md
                                        {% if orcamento.status == 'em_elaboracao' %}bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800
                                        {% elif orcamento.status == 'enviado' %}bg-gradient-to-r from-green-100 to-green-200 text-green-800
                                        {% elif orcamento.status == 'aceito' %}bg-gradient-to-r from-emerald-100 to-emerald-200 text-emerald-800
                                        {% else %}bg-gradient-to-r from-red-100 to-red-200 text-red-800{% endif %}">
                                        {{ orcamento.get_status_display }}
                                    </span>
                                </div>

                                <h4 class="font-semibold text-gray-900 mb-2">{{ orcamento.titulo }}</h4>
                                <p class="text-gray-700 leading-relaxed mb-4">{{ orcamento.descricao|truncatewords:25 }}</p>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-clock text-orange-600"></i>
                                        <span class="font-medium">{{ orcamento.prazo_execucao }} jours</span>
                                    </div>

                                    <div class="flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-calendar-alt text-red-600"></i>
                                        <span class="font-medium">Valide jusqu'au {{ orcamento.validade_orcamento|date:"d/m/Y" }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <div class="text-sm text-gray-600 mb-1">Total TTC</div>
                                <div class="text-3xl font-bold text-green-600">€{{ orcamento.total_ttc|floatformat:2 }}</div>

                                {% if orcamento.data_envio %}
                                <div class="text-xs text-gray-500 mt-2">
                                    Envoyé le {{ orcamento.data_envio|date:"d/m/Y" }}
                                </div>
                                {% endif %}

                                <!-- Botões de ação -->
                                <div class="flex flex-col gap-2 mt-4">
                                    <a href="{% url 'orcamentos:cliente_devis_detail' orcamento.numero %}"
                                       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-all duration-200 text-center">
                                        <i class="fas fa-eye mr-2"></i>Voir le devis
                                    </a>

                                    {% if orcamento.status == 'enviado' %}
                                        <div class="flex gap-2">
                                            <button onclick="accepterDevis('{{ orcamento.numero }}')"
                                                    class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                                <i class="fas fa-check mr-1"></i>Accepter
                                            </button>
                                            <button onclick="refuserDevis('{{ orcamento.numero }}')"
                                                    class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                                <i class="fas fa-times mr-1"></i>Refuser
                                            </button>
                                        </div>
                                    {% endif %}

                                    <a href="{% url 'orcamentos:cliente_devis_pdf' orcamento.numero %}" target="_blank"
                                       class="px-4 py-2 border-2 border-gray-300 hover:border-blue-500 text-gray-700 hover:text-blue-600 rounded-lg text-sm font-semibold transition-all duration-200 text-center hover:bg-blue-50">
                                        <i class="fas fa-download mr-2"></i>Télécharger PDF
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-32 h-32 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center mx-auto mb-8">
                    <i class="fas fa-file-invoice text-green-600 text-4xl"></i>
                </div>

                <h3 class="text-2xl font-bold text-gray-900 mb-4">
                    Aucun devis reçu
                </h3>

                <p class="text-gray-600 mb-8 max-w-md mx-auto leading-relaxed">
                    Vous n'avez pas encore reçu de devis. Faites une demande pour recevoir votre estimation personnalisée.
                </p>

                <a href="{% url 'orcamentos:solicitar_publico' %}"
                   class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-xl font-semibold shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-3">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Demander un devis
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Remove active class from all buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:text-blue-600', 'hover:bg-blue-50');
            });

            // Add active class to clicked button
            this.classList.add('active');
            this.classList.add('bg-blue-600', 'text-white');
            this.classList.remove('text-gray-600', 'hover:text-blue-600', 'hover:bg-blue-50');

            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            document.getElementById(tabId + '-tab').classList.remove('hidden');
        });
    });

    // Initialize first tab as active
    document.querySelector('.tab-button[data-tab="solicitacoes"]').click();
});

// Funções para aceitar/recusar devis
function accepterDevis(numero) {
    if (confirm('Êtes-vous sûr de vouloir accepter ce devis ?')) {
        fetch(`/orcamentos/devis/${numero}/accepter/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de l\'acceptation du devis');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'acceptation du devis');
        });
    }
}

function refuserDevis(numero) {
    if (confirm('Êtes-vous sûr de vouloir refuser ce devis ?')) {
        fetch(`/orcamentos/devis/${numero}/refuser/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors du refus du devis');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du refus du devis');
        });
    }
}
</script>

<style>
.tab-button {
    @apply text-gray-600 hover:text-blue-600 hover:bg-blue-50;
}

.tab-button.active {
    @apply bg-blue-600 text-white;
}
</style>
{% endblock %}
