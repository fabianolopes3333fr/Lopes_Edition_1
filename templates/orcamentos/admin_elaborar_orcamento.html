{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Élaborer Devis{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6 mb-10">
    <!-- Header moderno -->
    <div class="text-center lg:text-left mb-8">
        <h1 class="text-4xl font-bold text-green-900 mb-4 flex items-center justify-center lg:justify-start gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-file-circle-plus text-white text-2xl"></i>
            </div>
            {{ page_title }}
        </h1>
        <p class="text-xl text-gray-600">Création d'un nouveau devis professionnel - Élaboration détaillée des prestations.</p>
    </div>

    {% if solicitacao %}
    <!-- Informações da solicitação -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Demande de Devis - #{{ solicitacao.numero }}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-blue-700 mb-1">Client</label>
                    <p class="text-blue-900 font-semibold">{{ solicitacao.nome_solicitante }}</p>
                    <p class="text-blue-600 text-sm">{{ solicitacao.email_solicitante }}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-green-700 mb-1">Service demandé</label>
                    <p class="text-green-900 font-semibold">{{ solicitacao.get_tipo_servico_display }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <p class="text-gray-900">{{ solicitacao.descricao_servico|truncatewords:15 }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="POST" id="form-orcamento">
        {% csrf_token %}
        <input type="hidden" name="itens_json" id="itens-json">
        <input type="hidden" name="acomptes_json" id="acomptes-json">

        <!-- Informações do orçamento -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-file-invoice text-blue-600"></i>
                    Informations du Devis
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Titre du devis</label>
                        <input type="text" name="{{ form.titulo.name }}" value="{{ form.titulo.value|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Titre descriptif du devis...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Délai d'exécution (jours)</label>
                        <input type="number" name="{{ form.prazo_execucao.name }}" value="{{ form.prazo_execucao.value|default:'30' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Validité du devis</label>
                        <input type="date" name="{{ form.validade_orcamento.name }}" value="{{ form.validade_orcamento.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Remise globale (%)</label>
                        <input type="number" name="{{ form.desconto.name }}" value="{{ form.desconto.value|default:'0' }}"
                               step="0.01" min="0" max="100" id="desconto-global"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description générale</label>
                    <textarea name="{{ form.descricao.name }}" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Description détaillée des prestations...">{{ form.descricao.value|default:'' }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type de paiement</label>
                        <select name="{{ form.tipo_pagamento.name }}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="virement" {% if form.tipo_pagamento.value == 'virement' %}selected{% endif %}>Virement bancaire</option>
                            <option value="cheque" {% if form.tipo_pagamento.value == 'cheque' %}selected{% endif %}>Chèque</option>
                            <option value="espece" {% if form.tipo_pagamento.value == 'espece' %}selected{% endif %}>Espèce</option>
                            <option value="carte_bancaire" {% if form.tipo_pagamento.value == 'carte_bancaire' %}selected{% endif %}>Carte bancaire</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Conditions de paiement</label>
                        <select name="{{ form.condicoes_pagamento.name }}" id="condicoes-pagamento"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="comptant" {% if form.condicoes_pagamento.value == 'comptant' %}selected{% endif %}>Comptant</option>
                            <option value="acompte_30" {% if form.condicoes_pagamento.value == 'acompte_30' %}selected{% endif %}>30% d'acompte, solde à la fin</option>
                            <option value="acompte_50" {% if form.condicoes_pagamento.value == 'acompte_50' %}selected{% endif %}>50% d'acompte, solde à la fin</option>
                            <option value="echeance_30" {% if form.condicoes_pagamento.value == 'echeance_30' %}selected{% endif %}>Paiement à 30 jours</option>
                            <option value="echeance_60" {% if form.condicoes_pagamento.value == 'echeance_60' %}selected{% endif %}>Paiement à 60 jours</option>
                            <option value="personnalise" {% if form.condicoes_pagamento.value == 'personnalise' %}selected{% endif %}>Conditions personnalisées</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOVA SEÇÃO: Gestão de Acomptes -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6" id="acomptes-section" style="display: none;">
            <div class="flex justify-between items-center p-6 bg-gradient-to-r from-orange-50 to-yellow-50 border-b border-gray-200 rounded-t-2xl">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-euro-sign text-orange-600"></i>
                    Gestion des Acomptes
                </h2>
                <button type="button" id="btn-add-acompte"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    Ajouter un acompte
                </button>
            </div>

            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="w-full" id="acomptes-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">%</th>
                                <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">Montant TTC</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Échéance</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Statut</th>
                                <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="acomptes-body" class="divide-y divide-gray-100">
                            <!-- Acomptes will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <div class="text-center py-8 hidden" id="empty-acomptes-message">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-wallet text-4xl"></i>
                    </div>
                    <p class="text-gray-600">Aucun acompte configuré. Ajoutez des acomptes pour faciliter le paiement échelonné.</p>
                </div>

                <div class="mt-6 bg-orange-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-600">Total des acomptes</p>
                            <p class="text-lg font-bold text-orange-600" id="total-acomptes-ttc">0,00 €</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">% du devis</p>
                            <p class="text-lg font-bold text-orange-600" id="percentual-acomptes">0%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Solde restant</p>
                            <p class="text-lg font-bold text-green-600" id="solde-restant-ttc">0,00 €</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de produits/serviços -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
            <div class="flex justify-between items-center p-6 bg-gray-50 border-b border-gray-200 rounded-t-2xl">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-table text-blue-600"></i>
                    Produits et Services
                </h2>
                <button type="button" id="btn-add-item"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    Ajouter un item
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full" id="items-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Réf.</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Désignation</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Unité</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Qté</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">P.U HT</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">TVA</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Remise %</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">Total HT</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">Total TTC</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="items-body" class="divide-y divide-gray-100">
                        <!-- Itens serão carregados aqui pelo script -->
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr class="border-t-2 border-gray-300">
                            <td colspan="7" class="py-3 px-4 text-right font-semibold text-gray-700">Sous-total HT:</td>
                            <td class="py-3 px-4 text-right font-bold text-gray-900" id="subtotal-ht">0,00 €</td>
                            <td class="py-3 px-4 text-right font-bold text-gray-900" id="subtotal-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="7" class="py-3 px-4 text-right font-medium text-blue-600">TVA:</td>
                            <td class="py-3 px-4 text-right font-bold text-blue-600" id="total-tva">0,00 €</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 border-t-2 border-blue-500">
                            <td colspan="7" class="py-4 px-4 text-right font-bold text-xl text-blue-800">TOTAL TTC:</td>
	                        <td class="py-4 px-4 text-right font-bold text-xl text-green-600" id="total-final-ht">0,00 €</td>
                            <td class="py-4 px-4 text-right font-bold text-xl text-blue-600" id="total-final-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="8"></td>
                            <td class="py-3 px-4 text-right font-semibold text-orange-700">Acomptes TTC:</td>
                            <td class="py-3 px-4 text-right font-bold text-orange-600" id="sum-acomptes-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="8"></td>
                            <td class="py-3 px-4 text-right font-semibold text-green-700">Solde TTC:</td>
                            <td class="py-3 px-4 text-right font-bold text-green-600" id="solde-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="text-center py-12" id="empty-items-message">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-inbox text-5xl"></i>
                </div>
                <p class="text-gray-600">Aucun item ajouté. Cliquez sur "Ajouter un item" pour commencer.</p>
            </div>

            <!-- Observations -->
            <div class="bg-gray-50 p-6 border-t border-gray-200 rounded-b-2xl">
                <label class="block text-sm font-medium text-gray-700 mb-2">Observations</label>
                <textarea name="{{ form.observacoes.name }}" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Observations et conditions particulières...">{{ form.observacoes.value|default:'' }}</textarea>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <a href="{% url 'orcamentos:admin_orcamentos' %}"
               class="w-full sm:w-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-times"></i>
                Annuler
            </a>

            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <button type="submit" name="action" value="draft"
                        class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-save"></i>
                    Sauvegarder
                </button>

                <button type="submit" name="action" value="send"
                        class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                    Finaliser et envoyer
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modal para adicionar acompte -->
<div id="modal-add-acompte" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-euro-sign text-orange-600"></i>
                    <span id="acompte-modal-title">Ajouter un Acompte</span>
                </h3>
                <button type="button" id="btn-close-acompte-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type d'acompte</label>
                    <select id="acompte-tipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="inicial">Acompte initial</option>
                        <option value="intermediario">Acompte intermédiaire</option>
                        <option value="final">Solde final</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pourcentage (%)</label>
                    <input type="number" id="acompte-percentual" value="30" step="0.01" min="0" max="100"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <input type="text" id="acompte-descricao" placeholder="Ex: Acompte initial pour commencer les travaux"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date d'échéance</label>
                    <input type="date" id="acompte-data-vencimento"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type de paiement</label>
                    <select id="acompte-tipo-pagamento" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="virement">Virement bancaire</option>
                        <option value="cheque">Chèque</option>
                        <option value="espece">Espèce</option>
                        <option value="carte_bancaire">Carte bancaire</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 bg-orange-50 p-4 rounded-lg">
                <div class="flex justify-between items-center text-lg">
                    <span class="font-medium text-gray-700">Montant TTC (calculé):</span>
                    <span class="font-bold text-orange-600" id="modal-acompte-ttc">0,00€</span>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" id="btn-cancel-acompte" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                    Annuler
                </button>
                <button type="button" id="btn-confirm-acompte" class="flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors">
                    Ajouter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para adicionar item -->
<div id="modal-add-item" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i>
                    <span id="modal-title">Ajouter un Item</span>
                </h3>
                <button type="button" id="btn-close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Référence (rechercher un produit)</label>
                    <div class="relative">
                        <input type="text" id="item-referencia"
                               autocomplete="off"
                               placeholder="Tapez pour rechercher un produit..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="produto-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Désignation *</label>
                    <textarea id="item-descricao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unité</label>
                    <select id="item-unidade" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="unite">Unité</option>
                        <option value="piece">Pièce</option>
                        <option value="m2">M²</option>
                        <option value="ml">ML</option>
                        <option value="kg">Kg</option>
                        <option value="heure">Heure</option>
                        <option value="forfait">Forfait</option>
                    </select>
                </div>

                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activité</label>
                    <select id="item-atividade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="marchandise">Marchandise</option>
                        <option value="service">Service</option>
                    </select>
                 </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantité *</label>
                    <input type="number" id="item-quantidade" value="1" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prix Unitaire HT (€) *</label>
                    <input type="number" id="item-preco-ht" value="0" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Remise (%)</label>
                    <input type="number" id="item-remise" value="0" step="0.01" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">TVA (%)</label>
                    <select id="item-taxa-tva" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="20">20%</option>
                        <option value="10">10%</option>
                        <option value="5.5">5,5%</option>
                        <option value="0">Exonérée (0%)</option>
                    </select>
                </div>
            </div>

             <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center text-lg">
                    <span class="font-medium text-gray-700">Total HT:</span>
                    <span class="font-bold text-blue-600" id="modal-total-ht">0,00€</span>
                </div>
                <div class="flex justify-between items-center text-lg mt-2">
                    <span class="font-medium text-gray-700">Total TTC:</span>
                    <span class="font-bold text-blue-600" id="modal-total-ttc">0,00€</span>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" id="btn-cancel-item" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg">
                    Annuler
                </button>
                <button type="button" id="btn-confirm-item" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg" onclick="_lpConfirmItem()">
                    Ajouter
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- State Management ---
    let items = [];
    let acomptes = [];
    let editingIndex = -1;
    let editingAcompteIndex = -1;

    // --- Element Selectors ---
    // Modals
    const modalItem = document.getElementById('modal-add-item');
    const modalAcompte = document.getElementById('modal-add-acompte');

    // Buttons
    const btnAddItem = document.getElementById('btn-add-item');
    const btnAddAcompte = document.getElementById('btn-add-acompte');
    const btnCloseModal = document.getElementById('btn-close-modal');
    const btnCancelItem = document.getElementById('btn-cancel-item');
    const btnConfirmItem = document.getElementById('btn-confirm-item');
    const btnCloseAcompteModal = document.getElementById('btn-close-acompte-modal');
    const btnCancelAcompte = document.getElementById('btn-cancel-acompte');
    const btnConfirmAcompte = document.getElementById('btn-confirm-acompte');

    // Form and hidden inputs
    const formOrcamento = document.getElementById('form-orcamento');
    const itemsJsonInput = document.getElementById('itens-json');
    const acomptesJsonInput = document.getElementById('acomptes-json');
    const descontoGlobalInput = document.getElementById('desconto-global');

    // Item Modal Fields
    const itemModalTitle = document.getElementById('modal-title');
    const inputReferencia = document.getElementById('item-referencia');
    const inputDescricao = document.getElementById('item-descricao');
    const inputUnidade = document.getElementById('item-unidade');
    const inputAtividade = document.getElementById('item-atividade');
    const inputQuantidade = document.getElementById('item-quantidade');
    const inputPrecoHt = document.getElementById('item-preco-ht');
    const inputTaxaTva = document.getElementById('item-taxa-tva');
    const inputRemise = document.getElementById('item-remise');

    // Acompte Modal Fields
    const acompteModalTitle = document.getElementById('acompte-modal-title');
    const inputAcompteTipo = document.getElementById('acompte-tipo');
    const inputAcomptePercentual = document.getElementById('acompte-percentual');
    const inputAcompteDescricao = document.getElementById('acompte-descricao');
    const inputAcompteDataVencimento = document.getElementById('acompte-data-vencimento');
    const inputAcompteTipoPagamento = document.getElementById('acompte-tipo-pagamento');

    // Acomptes Section
    const condicoesPagamento = document.getElementById('condicoes-pagamento');
    const acomptesSection = document.getElementById('acomptes-section');

    // --- Functions (exposed) ---
    function confirmItem() {
        const descricao = (inputDescricao.value || '').trim();
        const quantidade = parseFloat(inputQuantidade.value) || 0;
        const precoHt = parseFloat(inputPrecoHt.value) || 0;
        const remise = parseFloat(inputRemise.value) || 0;
        const tva = parseFloat(inputTaxaTva.value) || 0;

        if (!descricao) { alert("Veuillez renseigner la désignation de l'item."); return; }
        if (quantidade <= 0) { alert("La quantité doit être supérieure à 0."); return; }
        if (precoHt < 0) { alert("Le prix unitaire HT ne peut pas être négatif."); return; }
        if (remise < 0 || remise > 100) { alert("La remise doit être entre 0 et 100%."); return; }
        if (tva < 0 || tva > 100) { alert("La TVA doit être entre 0 et 100%."); return; }

        const newItem = {
            referencia: inputReferencia.value || '',
            descricao: descricao,
            unidade: inputUnidade.value || 'unite',
            atividade: inputAtividade.value || 'marchandise',
            quantidade: quantidade,
            preco_unitario_ht: precoHt,
            taxa_tva: String(tva),
            remise_percentual: remise
        };

        if (editingIndex >= 0) {
            items[editingIndex] = newItem;
        } else {
            items.push(newItem);
        }
        editingIndex = -1; // reset edit state
        closeModal(modalItem);
        renderItems();
    }

    // Helper to parse numbers typed with comma or dot
    function parseLocaleNumber(val) {
        if (val == null) return 0;
        if (typeof val === 'number') return isNaN(val) ? 0 : val;
        const s = String(val).replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function confirmAcompte() {
        const percentual = parseLocaleNumber(inputAcomptePercentual.value) || 0;
        const tipo = inputAcompteTipo.value || 'inicial';
        const descricao = (inputAcompteDescricao.value || '').trim();
        const data_vencimento = inputAcompteDataVencimento.value || '';
        const tipo_pagamento = inputAcompteTipoPagamento.value || 'virement';

        if (percentual <= 0 || percentual > 100) { alert("Le pourcentage de l'acompte doit être entre 0 et 100%."); return; }

        const acompte = { tipo, descricao, percentual, data_vencimento, tipo_pagamento, status: 'pendente' };

        if (editingAcompteIndex >= 0) {
            acomptes[editingAcompteIndex] = acompte;
        } else {
            acomptes.push(acompte);
        }
        editingAcompteIndex = -1; // reset edit state
        closeModal(modalAcompte);
        renderAcomptes();
    }

    // Expose as globals for inline fallback
    window._lpConfirmItem = confirmItem;
    window._lpConfirmAcompte = confirmAcompte;

    // Bind explicitly (overrides inline to avoid double execution)
    if (btnConfirmItem) btnConfirmItem.onclick = confirmItem;
    if (btnConfirmAcompte) btnConfirmAcompte.onclick = confirmAcompte;

    // --- Initialization ---
    function initialize() {
        try {
            const initialItemsData = JSON.parse('{{ itens_json|escapejs }}' || '[]');
            items = (initialItemsData || []).map(item => ({
                ...item,
                quantidade: parseFloat(item.quantidade) || 0,
                preco_unitario_ht: parseFloat(item.preco_unitario_ht) || 0,
                remise_percentual: parseFloat(item.remise_percentual) || 0,
            }));
        } catch (e) {
            console.error("Error parsing initial items JSON:", e);
            items = [];
        }

        try {
            const initialAcomptesData = JSON.parse('{{ acomptes_json|escapejs }}' || '[]');
            acomptes = (initialAcomptesData || []).map(acompte => ({
                ...acompte,
                percentual: parseFloat(acompte.percentual) || 0,
            }));
        } catch (e) {
            console.error("Error parsing initial acomptes JSON:", e);
            acomptes = [];
        }

        renderItems();
        renderAcomptes();
        toggleAcomptesSection();
    }

    // --- Rendering ---
    function renderItems() {
        const tbody = document.getElementById('items-body');
        const emptyMessage = document.getElementById('empty-items-message');
        tbody.innerHTML = '';

        if (items.length === 0) {
            emptyMessage.style.display = 'block';
            tbody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-gray-500">Aucun item pour le moment.</td></tr>`;
        } else {
            emptyMessage.classList.add('hidden');

            items.forEach((item, index) => {
                const totalBrutoHt = item.quantidade * item.preco_unitario_ht;
                const valorRemise = (totalBrutoHt * (parseFloat(item.remise_percentual) || 0)) / 100;
                const totalHt = totalBrutoHt - valorRemise;
                const taxaTvaDecimal = (parseFloat(item.taxa_tva) || 0) / 100;
                const valorTva = totalHt * taxaTvaDecimal;
                const totalTtc = totalHt + valorTva;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm">${item.referencia || '-'}</td>
                    <td class="py-3 px-4 text-sm">${item.descricao || ''}</td>
                    <td class="py-3 px-4 text-center text-sm">${getUnidadeLabel(item.unidade)}</td>
                    <td class="py-3 px-4 text-center text-sm font-medium">${item.quantidade}</td>
                    <td class="py-3 px-4 text-right text-sm font-medium">${(parseFloat(item.preco_unitario_ht) || 0).toFixed(2)}€</td>
                    <td class="py-3 px-4 text-center text-xs"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${item.taxa_tva}%</span></td>
                    <td class="py-3 px-4 text-center text-xs">${(parseFloat(item.remise_percentual) || 0) > 0 ? '<span class="bg-red-100 text-red-800 px-2 py-1 rounded">' + item.remise_percentual + '%</span>' : '-'}</td>
                    <td class="py-3 px-4 text-right font-bold text-blue-600">${totalHt.toFixed(2)}€</td>
                    <td class="py-3 px-4 text-right font-bold text-blue-600">${totalTtc.toFixed(2)}€</td>
                    <td class="py-3 px-4 text-center">
                        <button type="button" class="btn-edit-item text-blue-600 hover:text-blue-800 mr-2" data-index="${index}" title="Éditer"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn-delete-item text-red-600 hover:text-red-800" data-index="${index}" title="Supprimer"><i class="fas fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(row);
            });
        }
        updateTotals();
        attachItemActionListeners();
    }

    function renderAcomptes() {
        const tbody = document.getElementById('acomptes-body');
        const emptyMessage = document.getElementById('empty-acomptes-message');
        tbody.innerHTML = '';

        if (acomptes.length === 0) {
            emptyMessage.classList.remove('hidden');
        } else {
            emptyMessage.classList.add('hidden');
            const { ttcAfterDiscount } = calculateTotals();

            acomptes.forEach((acompte, index) => {
                const acompteTtc = (ttcAfterDiscount * (parseFloat(acompte.percentual) || 0)) / 100;
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${acompte.status === 'pago' ? 'bg-green-50 text-gray-500' : ''}`;
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm"><span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">${getTipoAcompteLabel(acompte.tipo)}</span></td>
                    <td class="py-3 px-4 text-sm">${acompte.descricao || ''}</td>
                    <td class="py-3 px-4 text-center text-sm font-medium">${(parseFloat(acompte.percentual) || 0)}%</td>
                    <td class="py-3 px-4 text-right text-sm font-bold text-orange-600">${acompteTtc.toFixed(2)}€</td>
                    <td class="py-3 px-4 text-center text-sm">${acompte.data_vencimento ? new Date(acompte.data_vencimento + 'T00:00:00').toLocaleDateString('fr-FR') : '-'}</td>
                    <td class="py-3 px-4 text-center text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${acompte.status === 'pago' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${acompte.status || 'pendente'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        ${acompte.status !== 'pago' ? `
                        <button type="button" class="btn-edit-acompte text-blue-600 hover:text-blue-800 mr-2" data-index="${index}" title="Éditer"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn-delete-acompte text-red-600 hover:text-red-800" data-index="${index}" title="Supprimer"><i class="fas fa-trash"></i></button>
                        ` : '<span class="text-xs text-gray-400">Payé</span>'}
                    </td>`;
                tbody.appendChild(row);
            });
        }
        updateAcomptesSummary();
        attachAcompteActionListeners();
    }

    // --- Calculations ---
    function calculateTotals() {
        // Somar totais por item (já considerando remise por item)
        let sumHt = 0;
        let sumTtc = 0;

        items.forEach(item => {
            const itemHt = (parseFloat(item.quantidade) || 0) * (parseFloat(item.preco_unitario_ht) || 0) * (1 - ((parseFloat(item.remise_percentual) || 0) / 100));
            const itemTva = itemHt * ((parseFloat(item.taxa_tva) || 0) / 100);
            const itemTtc = itemHt + itemTva;
            sumHt += itemHt;
            sumTtc += itemTtc;
        });

        const descontoGlobal = parseFloat(descontoGlobalInput.value) || 0;
        const valorDescontoHt = sumHt * (descontoGlobal / 100);
        const htAfterDiscount = sumHt - valorDescontoHt;

        const valorDescontoTtc = sumTtc * (descontoGlobal / 100);
        const ttcAfterDiscount = sumTtc - valorDescontoTtc;

        const totalTvaAfter = Math.max(0, ttcAfterDiscount - htAfterDiscount);

        // Atualizar UI
        const elSubtotalHt = document.getElementById('subtotal-ht');
        const elSubtotalTtc = document.getElementById('subtotal-ttc');
        const elTotalTva = document.getElementById('total-tva');
        const elTotalFinalHt = document.getElementById('total-final-ht');
        const elTotalFinalTtc = document.getElementById('total-final-ttc');

        if (elSubtotalHt) elSubtotalHt.textContent = `${htAfterDiscount.toFixed(2)} €`;
        if (elSubtotalTtc) elSubtotalTtc.textContent = `${ttcAfterDiscount.toFixed(2)} €`;
        if (elTotalTva) elTotalTva.textContent = `${totalTvaAfter.toFixed(2)} €`;
        if (elTotalFinalHt) elTotalFinalHt.textContent = `${htAfterDiscount.toFixed(2)} €`;
        if (elTotalFinalTtc) elTotalFinalTtc.textContent = `${ttcAfterDiscount.toFixed(2)} €`;

        return { sumHt, sumTtc, htAfterDiscount, ttcAfterDiscount, totalTvaAfter, descontoGlobal };
    }

    function updateTotals() {
        calculateTotals();
        renderAcomptes(); // Recalculate acompte values when item totals change
    }

    function updateAcomptesSummary() {
        const { ttcAfterDiscount } = calculateTotals();
        let totalAcomptesValor = 0;
        let totalAcomptesPercentual = 0;

        acomptes.forEach(acompte => {
            totalAcomptesValor += (ttcAfterDiscount * (parseFloat(acompte.percentual) || 0)) / 100;
            totalAcomptesPercentual += (parseFloat(acompte.percentual) || 0);
        });

        const soldeRestant = Math.max(0, ttcAfterDiscount - totalAcomptesValor);

        const elTotalAcomptesTtc = document.getElementById('total-acomptes-ttc');
        const elPercentualAcomptes = document.getElementById('percentual-acomptes');
        const elSoldeRestantTtc = document.getElementById('solde-restant-ttc');
        const sumAcomptesTtcEl = document.getElementById('sum-acomptes-ttc');
        const soldeTtcEl = document.getElementById('solde-ttc');

        if (elTotalAcomptesTtc) elTotalAcomptesTtc.textContent = `${totalAcomptesValor.toFixed(2)} €`;
        if (elPercentualAcomptes) elPercentualAcomptes.textContent = `${totalAcomptesPercentual.toFixed(2)}%`;
        if (elSoldeRestantTtc) elSoldeRestantTtc.textContent = `${soldeRestant.toFixed(2)} €`;
        if (sumAcomptesTtcEl) sumAcomptesTtcEl.textContent = `${totalAcomptesValor.toFixed(2)} €`;
        if (soldeTtcEl) soldeTtcEl.textContent = `${soldeRestant.toFixed(2)} €`;
    }

    // --- Modal helpers ---
    function clearItemModalFields() {
        inputReferencia.value = '';
        inputDescricao.value = '';
        inputUnidade.value = 'unite';
        inputAtividade.value = 'marchandise';
        inputQuantidade.value = '1';
        inputPrecoHt.value = '0';
        inputTaxaTva.value = '20';
        inputRemise.value = '0';
        calculateModalItemTotals();
    }

    // --- Modal Management ---
    function openItemModal(index = -1) {
        editingIndex = index;
        if (index >= 0) {
            const item = items[index];
            itemModalTitle.textContent = "Éditer l'Item";
            btnConfirmItem.textContent = "Sauvegarder";
            inputReferencia.value = item.referencia || '';
            inputDescricao.value = item.descricao || '';
            inputUnidade.value = item.unidade || 'unite';
            inputAtividade.value = item.atividade || 'marchandise';
            inputQuantidade.value = item.quantidade;
            inputPrecoHt.value = item.preco_unitario_ht;
            inputTaxaTva.value = item.taxa_tva;
            inputRemise.value = item.remise_percentual;
        } else {
            itemModalTitle.textContent = "Ajouter un Item";
            btnConfirmItem.textContent = "Ajouter";
            clearItemModalFields();
        }
        calculateModalItemTotals();
        modalItem.classList.remove('hidden');
    }

    function openAcompteModal(index = -1) {
        editingAcompteIndex = index;
        if (index >= 0) {
            const acompte = acomptes[index];
            acompteModalTitle.textContent = "Éditer l'Acompte";
            btnConfirmAcompte.textContent = "Sauvegarder";
            inputAcompteTipo.value = acompte.tipo || 'inicial';
            inputAcomptePercentual.value = acompte.percentual || 0;
            inputAcompteDescricao.value = acompte.descricao || '';
            inputAcompteDataVencimento.value = acompte.data_vencimento || '';
            inputAcompteTipoPagamento.value = acompte.tipo_pagamento || 'virement';
        } else {
            acompteModalTitle.textContent = "Ajouter un Acompte";
            btnConfirmAcompte.textContent = "Ajouter";
            // Reset campos
            inputAcompteTipo.value = 'inicial';
            inputAcomptePercentual.value = 30;
            inputAcompteDescricao.value = '';
            inputAcompteDataVencimento.value = '';
            inputAcompteTipoPagamento.value = 'virement';
        }
        calculateModalAcompteTotals();
        modalAcompte.classList.remove('hidden');
    }

    function closeModal(modal) { modal.classList.add('hidden'); }

    // --- Event Listeners ---
    function attachItemActionListeners() {
        document.querySelectorAll('.btn-edit-item').forEach(btn => btn.addEventListener('click', (e) => openItemModal(parseInt(e.currentTarget.dataset.index))));
        document.querySelectorAll('.btn-delete-item').forEach(btn => btn.addEventListener('click', (e) => {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet item ?')) {
                items.splice(parseInt(e.currentTarget.dataset.index), 1);
                renderItems();
            }
        }));
    }

    function attachAcompteActionListeners() {
        document.querySelectorAll('.btn-edit-acompte').forEach(btn => btn.addEventListener('click', (e) => openAcompteModal(parseInt(e.currentTarget.dataset.index))));
        document.querySelectorAll('.btn-delete-acompte').forEach(btn => btn.addEventListener('click', (e) => {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet acompte ?')) {
                acomptes.splice(parseInt(e.currentTarget.dataset.index), 1);
                renderAcomptes();
            }
        }));
    }

    // Abrir/fechar modais
    btnAddItem.addEventListener('click', () => openItemModal());
    [btnCloseModal, btnCancelItem].forEach(btn => btn.addEventListener('click', () => closeModal(modalItem)));

    btnAddAcompte.addEventListener('click', () => openAcompteModal());
    [btnCloseAcompteModal, btnCancelAcompte].forEach(btn => btn.addEventListener('click', () => closeModal(modalAcompte)));

    // Fechar modais clicando no overlay
    modalItem.addEventListener('click', (e) => { if (e.target === modalItem) closeModal(modalItem); });
    modalAcompte.addEventListener('click', (e) => { if (e.target === modalAcompte) closeModal(modalAcompte); });

    // Fechar modais com tecla Esc
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (!modalItem.classList.contains('hidden')) closeModal(modalItem);
            if (!modalAcompte.classList.contains('hidden')) closeModal(modalAcompte);
        }
    });

    // Global listeners
    if (descontoGlobalInput) descontoGlobalInput.addEventListener('input', updateTotals);
    if (condicoesPagamento) condicoesPagamento.addEventListener('change', toggleAcomptesSection);
    [inputQuantidade, inputPrecoHt, inputTaxaTva, inputRemise].forEach(input => input.addEventListener('input', calculateModalItemTotals));
    inputAcomptePercentual.addEventListener('input', calculateModalAcompteTotals);

    // Remove duplicate confirm listeners; confirmItem/confirmAcompte are bound above

    formOrcamento.addEventListener('submit', function() {
        itemsJsonInput.value = JSON.stringify(items);
        acomptesJsonInput.value = JSON.stringify(acomptes);
    });

    // Enhance confirm functions to reset edit state
    const _origConfirmItem = confirmItem;
    window._lpConfirmItem = function() { _origConfirmItem(); editingIndex = -1; };
    if (btnConfirmItem) btnConfirmItem.onclick = window._lpConfirmItem;

    const _origConfirmAcompte = confirmAcompte;
    window._lpConfirmAcompte = function() { _origConfirmAcompte(); editingAcompteIndex = -1; };
    if (btnConfirmAcompte) btnConfirmAcompte.onclick = window._lpConfirmAcompte;

    // --- Helper Functions ---
    function toggleAcomptesSection() {
        const value = condicoesPagamento.value;
        if (value.includes('acompte') || value === 'personnalise') {
            acomptesSection.style.display = 'block';
        } else {
            acomptesSection.style.display = 'none';
            if (acomptes.length > 0 && confirm("Changer les conditions de paiement effacera les acomptes configurés. Continuer?")) {
                acomptes = [];
                renderAcomptes();
            }
        }
    }

    function calculateModalItemTotals() {
        const qte = parseFloat(inputQuantidade.value) || 0;
        const pu = parseFloat(inputPrecoHt.value) || 0;
        const tva = parseFloat(inputTaxaTva.value) || 0;
        const remise = parseFloat(inputRemise.value) || 0;
        const totalHt = (qte * pu) * (1 - remise / 100);
        const totalTtc = totalHt * (1 + tva / 100);
        document.getElementById('modal-total-ht').textContent = `${totalHt.toFixed(2)}€`;
        document.getElementById('modal-total-ttc').textContent = `${totalTtc.toFixed(2)}€`;
    }

    function calculateModalAcompteTotals() {
        const percentual = parseLocaleNumber(inputAcomptePercentual.value) || 0;
        const { ttcAfterDiscount } = calculateTotals();
        const acompteTtc = (ttcAfterDiscount * percentual) / 100;
        document.getElementById('modal-acompte-ttc').textContent = `${acompteTtc.toFixed(2)}€`;
    }

    function getUnidadeLabel(key) { return {'unite': 'Unité', 'piece': 'Pièce', 'm2': 'M²', 'ml': 'ML', 'kg': 'Kg', 'heure': 'Heure', 'forfait': 'Forfait'}[key] || key; }
    function getTipoAcompteLabel(key) { return {'inicial': 'Initial', 'intermediario': 'Intermédiaire', 'final': 'Solde'}[key] || key; }

    // --- Search Logic ---
    const suggestionsDiv = document.getElementById('produto-suggestions');
    inputReferencia.addEventListener('keyup', function() {
        const query = this.value;
        if (query.length < 2) {
            suggestionsDiv.classList.add('hidden');
            return;
        }
        fetch(`/devis/ajax/buscar-produtos/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionsDiv.innerHTML = '';
                if (data.produtos && data.produtos.length > 0) {
                    suggestionsDiv.classList.remove('hidden');
                    data.produtos.forEach(p => {
                        const div = document.createElement('div');
                        div.innerHTML = `<strong>${p.referencia}</strong> - ${p.nome} - <span class="text-green-600">${(p.preco_venda_ht || 0).toFixed(2)}€ HT</span> <span class="text-blue-600 text-xs">(${(p.preco_venda_ttc || 0).toFixed(2)}€ TTC)</span>`;
                        div.className = 'p-2 hover:bg-gray-200 cursor-pointer';
                        div.onclick = () => {
                            inputReferencia.value = p.referencia || '';
                            inputDescricao.value = p.descricao || '';
                            inputPrecoHt.value = p.preco_venda_ttc || 0;  // Preço TTC (COM IVA) - preço final para o cliente
                            inputUnidade.value = p.unidade || 'unite';
                            inputTaxaTva.value = p.taxa_tva || '20';  // Carregar a taxa de IVA do produto
                            if (p.atividade) inputAtividade.value = p.atividade;  // Carregar atividade do produto
                            suggestionsDiv.classList.add('hidden');
                            calculateModalItemTotals();
                        };
                        suggestionsDiv.appendChild(div);
                    });
                } else {
                    suggestionsDiv.classList.add('hidden');
                }
            });
    });
    document.addEventListener('click', function(e) {
        if (!suggestionsDiv.contains(e.target) && e.target !== inputReferencia) {
            suggestionsDiv.classList.add('hidden');
        }
    });

    // Initial load
    initialize();
});
</script>
{% endblock %}
