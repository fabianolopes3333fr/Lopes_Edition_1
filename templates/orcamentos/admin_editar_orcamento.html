{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Éditer Devis - {{ orcamento.numero }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6 mb-10">
    <!-- Header moderno -->
    <div class="text-center lg:text-left mb-8">
        <h1 class="text-4xl font-bold text-blue-900 mb-4 flex items-center justify-center lg:justify-start gap-4">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-edit text-white text-2xl"></i>
            </div>
            Éditer Devis - {{ orcamento.numero }}
        </h1>
        <p class="text-xl text-gray-600">Modification et mise à jour du devis existant - Gestion des produits et services.</p>
    </div>

    <!-- Informações do orçamento existente -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Devis - #{{ orcamento.numero }}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-blue-700 mb-1">Client</label>
                    <p class="text-blue-900 font-semibold">{{ orcamento.solicitacao.nome_solicitante }}</p>
                    <p class="text-blue-600 text-sm">{{ orcamento.solicitacao.email_solicitante }}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-green-700 mb-1">Service</label>
                    <p class="text-green-900 font-semibold">{{ orcamento.solicitacao.get_tipo_servico_display }}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <p class="text-gray-900 font-semibold">{{ orcamento.get_status_display }}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Création</label>
                    <p class="text-yellow-900 font-semibold">{{ orcamento.data_elaboracao|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="form-orcamento">
        {% csrf_token %}
        <input type="hidden" name="itens_json" id="itens-json">

        <!-- Informações do orçamento -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-file-invoice text-blue-600"></i>
                    Informations du Devis
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Titre du devis</label>
                        <input type="text" name="{{ form.titulo.name }}" value="{{ form.titulo.value|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Titre descriptif du devis...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Délai d'exécution (jours)</label>
                        <input type="number" name="{{ form.prazo_execucao.name }}" value="{{ form.prazo_execucao.value|default:'30' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Validité du devis</label>
                        <input type="date" name="{{ form.validade_orcamento.name }}" value="{{ form.validade_orcamento.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Remise globale (%)</label>
                        <input type="number" name="{{ form.desconto.name }}" value="{{ form.desconto.value|default:'0' }}"
                               step="0.01" min="0" max="100" id="desconto-global"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description générale</label>
                    <textarea name="{{ form.descricao.name }}" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Description détaillée des prestations...">{{ form.descricao.value|default:'' }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Type de paiement</label>
                        <select name="{{ form.tipo_pagamento.name }}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="virement" {% if form.tipo_pagamento.value == 'virement' %}selected{% endif %}>Virement bancaire</option>
                            <option value="cheque" {% if form.tipo_pagamento.value == 'cheque' %}selected{% endif %}>Chèque</option>
                            <option value="espece" {% if form.tipo_pagamento.value == 'espece' %}selected{% endif %}>Espèce</option>
                            <option value="carte_bancaire" {% if form.tipo_pagamento.value == 'carte_bancaire' %}selected{% endif %}>Carte bancaire</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Conditions de paiement</label>
                        <select name="{{ form.condicoes_pagamento.name }}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="comptant" {% if form.condicoes_pagamento.value == 'comptant' %}selected{% endif %}>Comptant</option>
                            <option value="acompte_30" {% if form.condicoes_pagamento.value == 'acompte_30' %}selected{% endif %}>30% d'acompte, solde à la fin</option>
                            <option value="acompte_50" {% if form.condicoes_pagamento.value == 'acompte_50' %}selected{% endif %}>50% d'acompte, solde à la fin</option>
                            <option value="echeance_30" {% if form.condicoes_pagamento.value == 'echeance_30' %}selected{% endif %}>Paiement à 30 jours</option>
                            <option value="echeance_60" {% if form.condicoes_pagamento.value == 'echeance_60' %}selected{% endif %}>Paiement à 60 jours</option>
                            <option value="personnalise" {% if form.condicoes_pagamento.value == 'personnalise' %}selected{% endif %}>Conditions personnalisées</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de produtos/serviços -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 mb-6">
            <div class="flex justify-between items-center p-6 bg-gray-50 border-b border-gray-200 rounded-t-2xl">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-table text-blue-600"></i>
                    Produits et Services
                </h2>
                <button type="button" id="btn-add-item"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    Ajouter un item
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full" id="items-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Réf.</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Désignation</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Unité</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Qté</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">P.U HT</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">TVA</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Remise %</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">Total HT</th>
                            <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase">Total TTC</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="items-body" class="divide-y divide-gray-100">
                        <!-- Items will be added here dynamically -->
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr class="border-t-2 border-gray-300">
                            <td colspan="7" class="py-3 px-4 text-right font-semibold text-gray-700">Sous-total HT:</td>
                            <td class="py-3 px-4 text-right font-bold text-gray-900" id="subtotal-ht">0,00 €</td>
                            <td class="py-3 px-4 text-right font-bold text-gray-900" id="subtotal-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="7" class="py-3 px-4 text-right font-medium text-blue-600">TVA:</td>
                            <td class="py-3 px-4 text-right font-bold text-blue-600" id="total-tva">0,00 €</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="bg-gradient-to-r from-blue-50 to-indigo-50 border-t-2 border-blue-500">
                            <td colspan="7" class="py-4 px-4 text-right font-bold text-xl text-blue-800">TOTAL:</td>
                            <td class="py-4 px-4 text-right font-bold text-xl text-blue-600" id="total-final-ht">0,00 €</td>
                            <td class="py-4 px-4 text-right font-bold text-xl text-blue-600" id="total-final-ttc">0,00 €</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="text-center py-12 hidden" id="empty-items-message">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-inbox text-5xl"></i>
                </div>
                <p class="text-gray-600">Aucun item ajouté. Cliquez sur "Ajouter un item" pour commencer.</p>
            </div>

            <!-- Observations -->
            <div class="bg-gray-50 p-6 border-t border-gray-200 rounded-b-2xl">
                <label class="block text-sm font-medium text-gray-700 mb-2">Observations</label>
                <textarea name="{{ form.observacoes.name }}" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Observations et conditions particulières...">{{ form.observacoes.value|default:'' }}</textarea>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <a href="{% url 'orcamentos:admin_orcamento_detail' orcamento.numero %}"
               class="w-full sm:w-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-times"></i>
                Annuler
            </a>

            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <button type="submit" name="action" value="draft"
                        class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-save"></i>
                    Sauvegarder
                </button>

                <button type="submit" name="action" value="send"
                        class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                    Finaliser et envoyer
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modal para adicionar item -->
<div id="modal-add-item" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-600"></i>
                    <span id="modal-title">Ajouter un Item</span>
                </h3>
                <button type="button" id="btn-close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Référence (rechercher un produit)</label>
                    <div class="relative">
                        <input type="text" id="item-referencia"
                               autocomplete="off"
                               placeholder="Tapez pour rechercher un produit..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div id="produto-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Désignation *</label>
                    <textarea id="item-descricao" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Description détaillée du produit ou service..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unité</label>
                    <select id="item-unidade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="unite">Unité</option>
                        <option value="piece">Pièce</option>
                        <option value="m2">M²</option>
                        <option value="ml">ML</option>
                        <option value="kg">Kg</option>
                        <option value="heure">Heure</option>
                        <option value="forfait">Forfait</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activité</label>
                    <select id="item-atividade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="marchandise">Marchandise</option>
                        <option value="service">Service</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantité *</label>
                    <input type="number" id="item-quantidade" value="1" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prix Unitaire HT (€) *</label>
                    <input type="number" id="item-preco-ht" value="0" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">TVA (%)</label>
                    <select id="item-taxa-tva" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="20">20%</option>
                        <option value="10">10%</option>
                        <option value="5.5">5,5%</option>
                        <option value="0">Exonérée (0%)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Remise (%)</label>
                    <input type="number" id="item-remise" value="0" step="0.01" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center text-lg">
                    <span class="font-medium text-gray-700">Total HT:</span>
                    <span class="font-bold text-blue-600" id="modal-total-ht">0,00€</span>
                </div>
                <div class="flex justify-between items-center text-lg mt-2">
                    <span class="font-medium text-gray-700">Total TTC:</span>
                    <span class="font-bold text-blue-600" id="modal-total-ttc">0,00€</span>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" id="btn-cancel-item" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                    Annuler
                </button>
                <button type="button" id="btn-confirm-item" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    <span id="btn-confirm-text">Ajouter</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let items = [];
    let editingIndex = -1;

    // Modal controls
    const modal = document.getElementById('modal-add-item');
    const btnAddItem = document.getElementById('btn-add-item');
    const btnCloseModal = document.getElementById('btn-close-modal');
    const btnCancelItem = document.getElementById('btn-cancel-item');
    const btnConfirmItem = document.getElementById('btn-confirm-item');
    const modalTitle = document.getElementById('modal-title');
    const btnConfirmText = document.getElementById('btn-confirm-text');

    // Form inputs
    const inputReferencia = document.getElementById('item-referencia');
    const inputDescricao = document.getElementById('item-descricao');
    const inputUnidade = document.getElementById('item-unidade');
    const inputAtividade = document.getElementById('item-atividade');
    const inputQuantidade = document.getElementById('item-quantidade');
    const inputPrecoHt = document.getElementById('item-preco-ht');
    const inputTaxaTva = document.getElementById('item-taxa-tva');
    const inputRemise = document.getElementById('item-remise');

    // Carregar dados existentes PRIMEIRO
    loadExistingItems();

    // Open modal para adicionar
    btnAddItem.addEventListener('click', function() {
        clearModalInputs();
        editingIndex = -1;
        modalTitle.textContent = 'Ajouter un Item';
        btnConfirmText.textContent = 'Ajouter';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    // Close modal
    function closeModal() {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    [btnCloseModal, btnCancelItem].forEach(btn => {
        btn.addEventListener('click', closeModal);
    });

    // Close modal on backdrop click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Calculate totals in modal
    [inputQuantidade, inputPrecoHt, inputTaxaTva, inputRemise].forEach(input => {
        input.addEventListener('input', calculateModalTotals);
    });

    function calculateModalTotals() {
        const quantidade = parseFloat(inputQuantidade.value) || 0;
        const precoHt = parseFloat(inputPrecoHt.value) || 0;
        const taxaTva = parseFloat(inputTaxaTva.value) || 0;
        const remise = parseFloat(inputRemise.value) || 0;

        const totalBrutoHt = quantidade * precoHt;
        const valorRemise = (totalBrutoHt * remise) / 100;
        const totalHt = totalBrutoHt - valorRemise;
        const valorTva = (totalHt * taxaTva) / 100;
        const totalTtc = totalHt + valorTva;

        document.getElementById('modal-total-ht').textContent = totalHt.toFixed(2) + '€';
        document.getElementById('modal-total-ttc').textContent = totalTtc.toFixed(2) + '€';
    }

    // Confirm item
    btnConfirmItem.addEventListener('click', function() {
        const descricao = inputDescricao.value.trim();
        if (!descricao) {
            alert('La désignation est obligatoire');
            return;
        }

        const item = {
            referencia: inputReferencia.value.trim(),
            descricao: descricao,
            unidade: inputUnidade.value,
            atividade: inputAtividade.value,
            quantidade: parseFloat(inputQuantidade.value) || 1,
            preco_unitario_ht: parseFloat(inputPrecoHt.value) || 0,
            taxa_tva: inputTaxaTva.value,
            remise_percentual: parseFloat(inputRemise.value) || 0
        };

        if (editingIndex >= 0) {
            items[editingIndex] = item;
        } else {
            items.push(item);
        }

        renderItems();
        closeModal();
    });

    function clearModalInputs() {
        inputReferencia.value = '';
        inputDescricao.value = '';
        inputUnidade.value = 'unite';
        inputAtividade.value = 'marchandise';
        inputQuantidade.value = '1';
        inputPrecoHt.value = '0';
        inputTaxaTva.value = '20';
        inputRemise.value = '0';
        calculateModalTotals();
    }

    function loadExistingItems() {
        // Carregar itens existentes do orçamento via AJAX
        const numeroOrcamento = '{{ orcamento.numero }}';
        fetch(`/devis/ajax/orcamento-items/${numeroOrcamento}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.items) {
                    items = data.items.map(item => ({
                        referencia: item.referencia || '',
                        descricao: item.descricao || '',
                        unidade: item.unidade || 'unite',
                        atividade: item.atividade || 'marchandise',
                        quantidade: parseFloat(item.quantidade) || 1,
                        preco_unitario_ht: parseFloat(item.preco_unitario_ht) || 0,
                        remise_percentual: parseFloat(item.remise_percentual) || 0,
                        taxa_tva: String(item.taxa_tva) || '20'
                    }));
                    console.log('✅ Items carregados via AJAX:', items.length);
                } else {
                    console.log('⚠️ Nenhum item encontrado:', data);
                    items = [];
                }
                renderItems();
            })
            .catch(error => {
                console.error('❌ Erro ao carregar itens via AJAX:', error);
                items = [];
                renderItems();
            });
    }

    function renderItems() {
        const tbody = document.getElementById('items-body');
        const emptyMessage = document.getElementById('empty-items-message');

        tbody.innerHTML = '';

        if (items.length === 0) {
            emptyMessage.classList.remove('hidden');
            updateTotals();
            return;
        }

        emptyMessage.classList.add('hidden');

        items.forEach((item, index) => {
            const totalBrutoHt = item.quantidade * item.preco_unitario_ht;
            const valorRemise = (totalBrutoHt * item.remise_percentual) / 100;
            const totalHt = totalBrutoHt - valorRemise;
            const taxaTvaDecimal = parseFloat(item.taxa_tva) / 100;
            const valorTva = totalHt * taxaTvaDecimal;
            const totalTtc = totalHt + valorTva;

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            row.innerHTML = `
                <td class="py-3 px-4 text-sm font-mono text-blue-600">${item.referencia || '-'}</td>
                <td class="py-3 px-4 text-sm">${item.descricao}</td>
                <td class="py-3 px-4 text-center text-sm">${getUnidadeLabel(item.unidade)}</td>
                <td class="py-3 px-4 text-center text-sm font-medium">${item.quantidade}</td>
                <td class="py-3 px-4 text-right text-sm font-medium">${item.preco_unitario_ht.toFixed(2)}€</td>
                <td class="py-3 px-4 text-center text-xs"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${item.taxa_tva}%</span></td>
                <td class="py-3 px-4 text-center text-xs">${item.remise_percentual > 0 ? '<span class="bg-red-100 text-red-800 px-2 py-1 rounded">' + item.remise_percentual + '%</span>' : '-'}</td>
                <td class="py-3 px-4 text-right font-bold text-blue-600">${totalHt.toFixed(2)}€</td>
                <td class="py-3 px-4 text-right font-bold text-blue-600">${totalTtc.toFixed(2)}€</td>
                <td class="py-3 px-4 text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button type="button" onclick="editItem(${index})" class="text-blue-600 hover:text-blue-800 p-1 rounded transition-colors" title="Éditer">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="deleteItem(${index})" class="text-red-600 hover:text-red-800 p-1 rounded transition-colors" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        updateTotals();
    }

    window.editItem = function(index) {
        editingIndex = index;
        const item = items[index];

        inputReferencia.value = item.referencia || '';
        inputDescricao.value = item.descricao || '';
        inputUnidade.value = item.unidade || 'unite';
        inputAtividade.value = item.atividade || 'marchandise';
        inputQuantidade.value = item.quantidade || 1;
        inputPrecoHt.value = item.preco_unitario_ht || 0;
        inputTaxaTva.value = item.taxa_tva || '20';
        inputRemise.value = item.remise_percentual || 0;

        modalTitle.textContent = 'Éditer un Item';
        btnConfirmText.textContent = 'Mettre à jour';

        calculateModalTotals();
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.deleteItem = function(index) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cet item?')) {
            items.splice(index, 1);
            renderItems();
        }
    };

    function updateTotals() {
        let subtotalHt = 0;
        let totalTva = 0;
        let subtotalTtc = 0;

        items.forEach(item => {
            const totalBrutoHt = item.quantidade * item.preco_unitario_ht;
            const valorRemise = (totalBrutoHt * item.remise_percentual) / 100;
            const totalHt = totalBrutoHt - valorRemise;
            const taxaTvaDecimal = parseFloat(item.taxa_tva) / 100;
            const valorTva = totalHt * taxaTvaDecimal;
            const totalTtc = totalHt + valorTva;

            subtotalHt += totalHt;
            totalTva += valorTva;
            subtotalTtc += totalTtc;
        });

        // Aplicar desconto global
        const descontoGlobal = parseFloat(document.getElementById('desconto-global').value) || 0;
        const valorDescontoGlobal = (subtotalHt * descontoGlobal) / 100;
        const totalHtComDesconto = subtotalHt - valorDescontoGlobal;
        const valorDescontoTva = (totalTva * descontoGlobal) / 100;
        const totalTvaComDesconto = totalTva - valorDescontoTva;
        const totalFinal = totalHtComDesconto + totalTvaComDesconto;

        document.getElementById('subtotal-ht').textContent = totalHtComDesconto.toFixed(2) + '€';
        document.getElementById('subtotal-ttc').textContent = subtotalTtc.toFixed(2) + '€';
        document.getElementById('total-tva').textContent = totalTvaComDesconto.toFixed(2) + '€';
        document.getElementById('total-final-ht').textContent = totalHtComDesconto.toFixed(2) + '€';
        document.getElementById('total-final-ttc').textContent = totalFinal.toFixed(2) + '€';

        // Update hidden input
        document.getElementById('itens-json').value = JSON.stringify(items);
    }

    function getUnidadeLabel(unidade) {
        const labels = {
            'unite': 'Unité',
            'piece': 'Pièce',
            'm2': 'M²',
            'ml': 'ML',
            'kg': 'Kg',
            'heure': 'Heure',
            'forfait': 'Forfait'
        };
        return labels[unidade] || unidade;
    }

    // Form submission
    document.getElementById('form-orcamento').addEventListener('submit', function() {
        updateTotals(); // Ensure JSON is up to date
    });

    // Desconto global listener
    document.getElementById('desconto-global').addEventListener('input', function() {
        updateTotals();
    });

    // ==== AUTOCOMPLETE DE PRODUTOS ====
    let produtosCache = {};
    const suggestionBox = document.getElementById('produto-suggestions');

    // Função para buscar produtos
    async function buscarProdutos(searchTerm) {
        if (produtosCache[searchTerm]) {
            return produtosCache[searchTerm];
        }

        try {
            const response = await fetch(`/devis/ajax/buscar-produtos/?q=${encodeURIComponent(searchTerm)}`);
            const data = await response.json();
            produtosCache[searchTerm] = data.produtos || [];
            return produtosCache[searchTerm];
        } catch (error) {
            console.error('Erro ao buscar produtos:', error);
            return [];
        }
    }

    // Configurar autocomplete
    inputReferencia.addEventListener('input', async function() {
        const searchTerm = this.value.trim();

        if (searchTerm.length < 2) {
            suggestionBox.classList.add('hidden');
            return;
        }

        const produtos = await buscarProdutos(searchTerm);

        if (produtos.length > 0) {
            let html = '';
            produtos.forEach(produto => {
                html += `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 transition-colors" onclick="selecionarProduto('${produto.referencia}', '${produto.nome}', ${produto.preco_venda})">
                        <div class="font-medium text-sm">${produto.referencia} - ${produto.nome}</div>
                        <div class="text-xs text-gray-500">${produto.preco_venda}€ HT</div>
                    </div>
                `;
            });
            suggestionBox.innerHTML = html;
            suggestionBox.classList.remove('hidden');
        } else {
            suggestionBox.innerHTML = '<div class="p-3 text-gray-500 text-sm">Aucun produit trouvé</div>';
            suggestionBox.classList.remove('hidden');
        }
    });

    window.selecionarProduto = function(referencia, nome, preco) {
        inputReferencia.value = referencia;
        inputDescricao.value = nome;
        inputPrecoHt.value = preco;
        suggestionBox.classList.add('hidden');
        calculateModalTotals();
    };

    // Esconder sugestões quando clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.relative')) {
            suggestionBox.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
