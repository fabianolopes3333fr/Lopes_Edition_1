{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Éditer Devis - {{ orcamento.numero }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6 mb-10">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                <i class="fas fa-edit text-blue-600"></i>
                Éditer Devis - {{ orcamento.numero }}
            </h1>
            <p class="text-gray-600 mt-1">{{ orcamento.solicitacao.nome_solicitante }} - {{ orcamento.solicitacao.email_solicitante }}</p>
        </div>

        <div class="flex gap-3">
            <a href="{% url 'orcamentos:admin_orcamento_detail' orcamento.numero %}"
               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                Retour
            </a>
        </div>
    </div>

    <form method="POST" id="form-orcamento">
        {% csrf_token %}
        <input type="hidden" name="itens_json" id="itens-json">

        <!-- Informações do orçamento -->
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Informations du Devis
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Titre du devis</label>
                    <input type="text" name="{{ form.titulo.name }}" value="{{ form.titulo.value|default:'' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Délai d'exécution (jours)</label>
                    <input type="number" name="{{ form.prazo_execucao.name }}" value="{{ form.prazo_execucao.value|default:'30' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Validité du devis</label>
                    <input type="date" name="{{ form.validade_orcamento.name }}" value="{{ form.validade_orcamento.value|date:'Y-m-d'|default:'' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Remise globale (%)</label>
                    <input type="number" name="{{ form.desconto.name }}" value="{{ form.desconto.value|default:'0' }}"
                           step="0.01" min="0" max="100" id="desconto-global"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea name="{{ form.descricao.name }}" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ form.descricao.value|default:'' }}</textarea>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Conditions de paiement</label>
                <textarea name="{{ form.condicoes_pagamento.name }}" rows="2"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ form.condicoes_pagamento.value|default:'' }}</textarea>
            </div>
        </div>

        <!-- Tabela de produtos/serviços -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-table text-blue-600"></i>
                    Produits et Services
                </h2>
                <button type="button" id="btn-add-row"
                        class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full" id="products-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recherche</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Référence</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Désignation</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unité</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qté</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P.U HT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P.U TTC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">% Remise</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total HT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total TTC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Taxe</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activité</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <!-- Linhas serão adicionadas via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Totais -->
            <div class="bg-gray-50 p-6 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observations</label>
                        <textarea name="{{ form.observacoes.name }}" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ form.observacoes.value|default:'' }}</textarea>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-700">Total HT:</span>
                            <span class="font-bold text-lg" id="total-ht">0,00 €</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-700">Total TVA:</span>
                            <span class="font-bold text-lg" id="total-tva">0,00 €</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-700">Total TTC:</span>
                            <span class="font-bold text-lg" id="total-ttc">0,00 €</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <span class="font-medium text-gray-500">Total Achats:</span>
                            <span class="font-bold text-gray-500" id="total-achats">0,00 €</span>
                        </div>
                        <div class="flex justify-between items-center py-3 border-t-2 border-blue-500">
                            <span class="font-bold text-xl text-blue-900">TOTAL FINAL:</span>
                            <span class="font-bold text-2xl text-blue-600" id="total-final">0,00 €</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de ação -->
        <div class="flex justify-between items-center">
            <a href="{% url 'orcamentos:admin_orcamento_detail' orcamento.numero %}"
               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                <i class="fas fa-times"></i>
                Annuler
            </a>

            <div class="flex gap-3">
                <button type="submit" name="action" value="draft"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    Sauvegarder
                </button>

                <button type="submit" name="action" value="send"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i>
                    Finaliser et envoyer
                </button>
            </div>
        </div>
    </form>
</div>

<script>
let rowCounter = 0;

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Carregar itens existentes do orçamento
    loadExistingItems();

    // Event listener para adicionar nova linha
    document.getElementById('btn-add-row').addEventListener('click', function() {
        addRowWithData();
    });

    // Event listener para salvar antes de submeter
    document.getElementById('form-orcamento').addEventListener('submit', function() {
        saveItemsToJson();
    });

    // Event listener para desconto global
    document.getElementById('desconto-global').addEventListener('input', function() {
        calculateTotals();
    });
});

function loadExistingItems() {
    // Dados dos itens existentes do orçamento (passados do backend)
    const existingItems = {{ existing_items|safe }} || [];

    if (existingItems.length === 0) {
        // Se não há itens, adicionar uma linha vazia
        addRowWithData();
    } else {
        // Carregar itens existentes
        existingItems.forEach(item => {
            const itemData = {
                produto_id: item.produto_id,
                referencia: item.referencia || '',
                descricao: item.descricao || '',
                unidade: item.unidade || 'unite',
                atividade: item.atividade || 'marchandise',
                quantidade: item.quantidade || 1,
                preco_unitario_ht: item.preco_unitario_ht || 0,
                remise_percentual: item.remise_percentual || 0,
                taxa_tva: item.taxa_tva || 20,
                preco_compra_unitario: item.preco_compra_unitario || 0
            };
            addRowWithData(itemData);
        });
    }
}

function addRowWithData(itemData = {}) {
    rowCounter++;
    const tbody = document.getElementById('products-tbody');
    const row = document.createElement('tr');
    row.setAttribute('data-row', rowCounter);
    row.className = 'border-b border-gray-200 hover:bg-gray-50';

    // Calcular preço TTC se não existir
    const precoHt = parseFloat(itemData.preco_unitario_ht) || 0;
    const taxaTva = parseFloat(itemData.taxa_tva) || 20;
    const precoTtc = precoHt * (1 + (taxaTva / 100));

    // Calcular totais se não existirem
    const quantidade = parseFloat(itemData.quantidade) || 1;
    const remise = parseFloat(itemData.remise_percentual) || 0;
    const totalBrutoHt = quantidade * precoHt;
    const valorRemise = (totalBrutoHt * remise) / 100;
    const totalLiquidoHt = totalBrutoHt - valorRemise;
    const valorTva = totalLiquidoHt * (taxaTva / 100);
    const totalTtc = totalLiquidoHt + valorTva;

    row.innerHTML = `
        <td class="px-4 py-3">
            <div class="relative">
                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded search-input"
                       placeholder="Rechercher..." data-row="${rowCounter}" oninput="searchProducts(this)"
                       value="${itemData.referencia || ''}">
                <div class="search-results absolute z-10 w-full bg-white border border-gray-300 rounded-b shadow-lg hidden"
                     id="results-${rowCounter}"></div>
                <input type="hidden" class="produto-id" value="${itemData.produto_id || ''}">
                <input type="hidden" class="preco-compra" value="${itemData.preco_compra_unitario || 0}">
            </div>
        </td>
        <td class="px-4 py-3">
            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded referencia"
                   value="${itemData.referencia || ''}" readonly>
        </td>
        <td class="px-4 py-3">
            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded descricao"
                   placeholder="Description..." value="${itemData.descricao || ''}">
        </td>
        <td class="px-4 py-3">
            <select class="w-full px-3 py-2 border border-gray-300 rounded unidade" onchange="calculateRowTotal(this)">
                <option value="unite" ${itemData.unidade === 'unite' ? 'selected' : ''}>Unité</option>
                <option value="piece" ${itemData.unidade === 'piece' ? 'selected' : ''}>Pièce</option>
                <option value="m2" ${itemData.unidade === 'm2' ? 'selected' : ''}>M²</option>
                <option value="ml" ${itemData.unidade === 'ml' ? 'selected' : ''}>ML</option>
                <option value="longueur" ${itemData.unidade === 'longueur' ? 'selected' : ''}>Longueur</option>
                <option value="kg" ${itemData.unidade === 'kg' ? 'selected' : ''}>Kg</option>
                <option value="heure" ${itemData.unidade === 'heure' ? 'selected' : ''}>Heure</option>
                <option value="forfait" ${itemData.unidade === 'forfait' ? 'selected' : ''}>Forfait</option>
            </select>
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded quantidade"
                   step="0.01" min="0" value="${quantidade}" oninput="calculateRowTotal(this)">
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded preco-ht"
                   step="0.01" min="0" value="${precoHt}" oninput="calculateRowTotal(this)">
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded preco-ttc"
                   step="0.01" min="0" value="${precoTtc.toFixed(2)}" readonly>
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded remise"
                   step="0.01" min="0" max="100" value="${remise}" oninput="calculateRowTotal(this)">
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded total-ht"
                   step="0.01" readonly value="${totalLiquidoHt.toFixed(2)}">
        </td>
        <td class="px-4 py-3">
            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded total-ttc"
                   step="0.01" readonly value="${totalTtc.toFixed(2)}">
        </td>
        <td class="px-4 py-3">
            <select class="w-full px-3 py-2 border border-gray-300 rounded taxa-tva" onchange="calculateRowTotal(this)">
                <option value="20" ${itemData.taxa_tva === '20' || itemData.taxa_tva === 20 ? 'selected' : ''}>TVA 20%</option>
                <option value="10" ${itemData.taxa_tva === '10' || itemData.taxa_tva === 10 ? 'selected' : ''}>TVA 10%</option>
                <option value="5.5" ${itemData.taxa_tva === '5.5' || itemData.taxa_tva === 5.5 ? 'selected' : ''}>TVA 5,5%</option>
                <option value="0" ${itemData.taxa_tva === '0' || itemData.taxa_tva === 0 ? 'selected' : ''}>Exonérée</option>
            </select>
        </td>
        <td class="px-4 py-3">
            <select class="w-full px-3 py-2 border border-gray-300 rounded atividade">
                <option value="marchandise" ${itemData.atividade === 'marchandise' ? 'selected' : ''}>Marchandise</option>
                <option value="service" ${itemData.atividade === 'service' ? 'selected' : ''}>Service</option>
            </select>
        </td>
        <td class="px-4 py-3 text-center">
            <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded"
                    onclick="removeRow(this)" title="Supprimer">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

        tbody.appendChild(row);

    // Calcular totais da linha após adicionar
    calculateRowTotal(row.querySelector('.quantidade'));
}

function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
    calculateTotals();
}

function calculateRowTotal(element) {
    const row = element.closest('tr');
    const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
    const precoHt = parseFloat(row.querySelector('.preco-ht').value) || 0;
    const remise = parseFloat(row.querySelector('.remise').value) || 0;

    // Corrigir o problema com TVA 0% (Exonérée) - não usar || pois 0 é falsy
    const taxaTvaElement = row.querySelector('.taxa-tva');
    const taxaTva = taxaTvaElement ? parseFloat(taxaTvaElement.value) : 20;

    // Calcular preço TTC
    const precoTtc = precoHt * (1 + (taxaTva / 100));
    row.querySelector('.preco-ttc').value = precoTtc.toFixed(2);

    // Calcular totais da linha
    const totalBrutoHt = quantidade * precoHt;
    const valorRemise = (totalBrutoHt * remise) / 100;
    const totalLiquidoHt = totalBrutoHt - valorRemise;
    const valorTva = totalLiquidoHt * (taxaTva / 100);
    const totalTtc = totalLiquidoHt + valorTva;

    row.querySelector('.total-ht').value = totalLiquidoHt.toFixed(2);
    row.querySelector('.total-ttc').value = totalTtc.toFixed(2);

    calculateTotals();
}

function calculateTotals() {
    let totalHt = 0;
    let totalTva = 0;
    let totalTtc = 0;
    let totalAchats = 0;

    document.querySelectorAll('#products-tbody tr').forEach(row => {
        const rowTotalHt = parseFloat(row.querySelector('.total-ht').value) || 0;
        const rowTotalTtc = parseFloat(row.querySelector('.total-ttc').value) || 0;
        const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
        const precoCompra = parseFloat(row.querySelector('.preco-compra').value) || 0;

        totalHt += rowTotalHt;
        totalTtc += rowTotalTtc;
        totalAchats += quantidade * precoCompra;
    });

    totalTva = totalTtc - totalHt;

    // Aplicar desconto global sobre o total HT
    const descontoGlobal = parseFloat(document.getElementById('desconto-global').value) || 0;
    const valorDescontoGlobal = (totalHt * descontoGlobal) / 100;
    const totalHtComDesconto = totalHt - valorDescontoGlobal;

    // Aplicar desconto sobre a TVA também
    const valorDescontoTva = (totalTva * descontoGlobal) / 100;
    const totalTvaComDesconto = totalTva - valorDescontoTva;

    // Total final é HT com desconto + TVA com desconto
    const totalFinal = totalHtComDesconto + totalTvaComDesconto;

    document.getElementById('total-ht').textContent = totalHtComDesconto.toFixed(2) + ' €';
    document.getElementById('total-tva').textContent = totalTvaComDesconto.toFixed(2) + ' €';
    document.getElementById('total-ttc').textContent = totalTtc.toFixed(2) + ' €';
    document.getElementById('total-achats').textContent = totalAchats.toFixed(2) + ' €';
    document.getElementById('total-final').textContent = totalFinal.toFixed(2) + ' €';
}

function saveItemsToJson() {
    const items = [];
    document.querySelectorAll('#products-tbody tr').forEach(row => {
        const descricao = row.querySelector('.descricao').value.trim();
        if (descricao) {
            items.push({
                produto_id: row.querySelector('.produto-id').value || null,
                referencia: row.querySelector('.referencia').value,
                descricao: descricao,
                unidade: row.querySelector('.unidade').value,
                atividade: row.querySelector('.atividade').value,
                quantidade: parseFloat(row.querySelector('.quantidade').value) || 1,
                preco_unitario_ht: parseFloat(row.querySelector('.preco-ht').value) || 0,
                remise_percentual: parseFloat(row.querySelector('.remise').value) || 0,
                taxa_tva: row.querySelector('.taxa-tva').value,
                preco_compra_unitario: parseFloat(row.querySelector('.preco-compra').value) || 0
            });
        }
    });

    document.getElementById('itens-json').value = JSON.stringify(items);
}

function searchProducts(input) {
    const query = input.value.trim();
    const rowId = input.getAttribute('data-row');
    const resultsDiv = document.getElementById(`results-${rowId}`);

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    fetch(`/orcamentos/admin/produtos/buscar/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.produtos && data.produtos.length > 0) {
                let html = '';
                data.produtos.forEach(produto => {
                    html += `
                        <div class="p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100"
                             onclick="selectProduct(${rowId}, ${produto.id}, '${produto.referencia}', '${produto.nome}', ${produto.preco_venda}, ${produto.preco_compra})">
                            <div class="font-medium text-sm">${produto.referencia} - ${produto.nome}</div>
                            <div class="text-xs text-gray-500">${produto.preco_venda}€ HT</div>
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = '<div class="p-2 text-gray-500 text-sm">Aucun produit trouvé</div>';
                resultsDiv.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Erro na busca:', error);
            resultsDiv.classList.add('hidden');
        });
}

function selectProduct(rowId, produtoId, referencia, nome, precoVenda, precoCompra) {
    const row = document.querySelector(`tr[data-row="${rowId}"]`);

    row.querySelector('.produto-id').value = produtoId;
    row.querySelector('.referencia').value = referencia;
    row.querySelector('.descricao').value = nome;
    row.querySelector('.preco-ht').value = precoVenda;
    row.querySelector('.preco-compra').value = precoCompra;
    row.querySelector('.search-input').value = referencia;

    // Esconder resultados
    document.getElementById(`results-${rowId}`).classList.add('hidden');

    // Calcular totais da linha
    calculateRowTotal(row.querySelector('.quantidade'));
}

// Esconder resultados quando clicar fora
document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative')) {
        document.querySelectorAll('.search-results').forEach(div => {
            div.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
