{% load currency_filters %}

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Devis - Lopes Peinture</title>
    <style>
      @page {
        size: A4;
        margin: 0;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 9pt;
        line-height: 1.5;
        color: #000;
        background: #fff;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .page {
        width: 210mm;
        min-height: 297mm;
        padding: 15mm;
        margin: 0 auto;
        background: white;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
      }

      .logo-section {
        flex: 1;
      }

      .logo {
        max-width: 100%;
        height: auto;
        font-size: 32pt;
        font-weight: bold;
        color: #000;
        margin-bottom: 0;
        line-height: 1;
      }
      .company-tagline {
        font-size: 12pt;
        opacity: 0.9;
        font-weight: 400;
        position: relative;
        color: #6b9c3d;
        z-index: 1;
      }

      .logo-subtitle {
        font-size: 18pt;
        color: #6b9c3d;
        font-weight: bold;
        margin-left: 5px;
      }
      .row {
        display: flex;
        justify-content: space-between;
      }
      .company-info {
        font-size: 8pt;
        line-height: 1.5;
        margin-top: 15px;
      }

      .date-section {
        text-align: right;
        font-size: 9pt;
      }

      .client-header {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        margin-bottom: 5px;
      }

      .client-info {
        flex: 1;
        font-size: 9pt;
        line-height: 1.6;
      }

      .devis-title {
        font-size: 18pt;
        font-weight: bold;
        color: #5b9bd5;
        margin-bottom: 10px;
      }

      .devis-meta {
        display: flex;

        gap: 40px;
        font-size: 9pt;
        margin-bottom: 3px;
      }
      .invoice-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 8pt;
      }

      .invoice-table th {
        background: linear-gradient(to bottom, #5b9bd5 0%, #4a8ec4 100%);
        color: white;
        padding: 8px 4px;
        text-align: center;
        font-size: 7.5pt;
        font-weight: bold;
        border: 2px solid #4a8ec4;
      }

      .invoice-table th:first-child,
      .invoice-table th:nth-child(2) {
        text-align: left;
      }

      .invoice-table td {
        padding: 5px 4px;
        border: 2px solid #e0e0e0;
        text-align: right;
      }

      .invoice-table td:first-child,
      .invoice-table td:nth-child(2) {
        text-align: left;
      }

      .invoice-table tbody tr:nth-child(even) {
        background: #fffef5;
      }

      .item-title {
        font-weight: bold;
        margin-bottom: 3px;
      }

      .item-detail {
        color: #666;
        font-size: 7.5pt;
        line-height: 1.4;
      }

      .item-description {
        grid-column: 1 / 3;
        padding-right: 10px;
      }

      .item-title {
        font-weight: bold;
        margin-bottom: 3px;
      }

      .item-detail {
        color: #666;
        font-size: 7.5pt;
        line-height: 1.4;
      }

      .footer {
        margin-top: auto;
        padding-top: 20px;
        border-top: 2px solid #ddd;
      }

      .payment-note {
        font-size: 8pt;
        margin-bottom: 10px;
      }

      .payment-note strong {
        color: #000;
      }

      .validity-note {
        color: red;
        font-size: 8pt;
        margin-bottom: 15px;
      }

      .totals-section {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
      }

      .totals-box {
        width: 300px;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 15px;
        background: #e8f0f8;
        margin-bottom: 2px;
        font-size: 9pt;
      }

      .total-row.highlight {
        background: #5b9bd5;
        color: white;
        font-weight: bold;
        font-size: 10pt;
      }

      .payment-info {
        font-size: 7.5pt;
        line-height: 1.6;
        color: #333;
        text-align: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
      }

      .text-right {
        text-align: right !important;
      }

      .text-center {
        text-align: center !important;
      }

      /* ===== PRINT CONTROLS ===== */
      .print-controls {
        position: fixed;
        top: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        gap: 15px;
      }

      .print-btn {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .print-btn:hover {
        background: linear-gradient(135deg, #1e40af, #1d4ed8);
        transform: translateY(-3px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .download-btn {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .download-btn:hover {
        background: linear-gradient(135deg, #047857, #065f46);
        transform: translateY(-3px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- Print Controls -->
    <div class="print-controls no-print">
      <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer PDF</button>
      <button class="download-btn" onclick="downloadHTML()">üíæ T√©l√©charger HTML</button>
    </div>
    <div class="page">
      <div class="content-area">
        <div class="header">
          <div class="logo-section">
            <div>
              <img
                class="logo"
                src="http://127.0.0.1:8000/static/img/logo-220x80-preto.svg"
                alt="LOPES"
              />
            </div>
            <div class="row">
              <div class="company-info">
                <strong>EI : {{ company_info.name }}</strong> <br />
                SIRET: {{ company_info.siret }}<br />
                APE: {{ company_info.ape }} - TVA: {{ company_info.tva }} <br>
                  {{ company_info.address }}<br />
                {{ company_info.city }}<br />
                France<br />
                {{ company_info.phone }}<br />
                {{ company_info.email }}<br />
                www.lopespeinture.fr
              </div>
              <div class="client-header">
                <div class="client-info">
                  <strong>{{ orcamento.solicitacao.nome_solicitante }}</strong><br />
                  {{ orcamento.solicitacao.endereco }}<br>
                        {{ orcamento.solicitacao.cidade }}, {{ orcamento.solicitacao.cep }}<br>
                        {{ orcamento.solicitacao.email_solicitante }}<br>

                </div>
              </div>
            </div>
          </div>
          <div class="date-section">Le {{ date_generation|date:"d/m/Y" }}</div>
        </div>

        <div class="devis-title">Devis</div>

        <div class="devis-meta">
          <div><strong>DEVIS N¬∞ {{ orcamento.numero }}</strong></div>
          <div><strong>Code Client : 1</strong></div>
          <div><strong>TVA Client :</strong></div>
        </div>
        {% if items_data %}
        <table class="invoice-table">
          <thead>
            <tr>
              <th>R√©f</th>
              <th>D√©signation</th>
              <th>Unit√©</th>
              <th>Quantit√©</th>
              <th>P.U. HT</th>
              <th>P.U.TTC</th>
              <th>Remise</th>
              <th>Total HT</th>
              <th>Total TTC</th>
              <th>Taux</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items_data %}
            <tr>
              <td>{{ item.ref }}</td>
              <td class="text-left item-detail">{{ item.designation }}</td>
              <td class="text-center">{{ item.unite }}</td>
              <td class="text-right">{{ item.quantite }}</td>
              <td class="text-right">{{ item.pu_ht|floatformat:2 }}‚Ç¨</td>
              <td class="text-right">{{ item.pu_ttc|floatformat:2 }}‚Ç¨</td>
              <td class="text-right">{{ item.remise|floatformat:2 }}‚Ç¨</td>
              <td class="text-right">{{ item.total_ht|floatformat:2 }}‚Ç¨</td>
              <td class="text-right">{{ item.total_ttc|floatformat:2 }}‚Ç¨</td>
              <td class="text-right">{{ item.taxe|floatformat:2 }}‚Ç¨</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="footer">
        <div class="payment-note"><strong>Mode de reglement :</strong> Virement</div>
        <div class="condition-item">
          <h4>Conditions de paiement</h4>
          <p>{{ orcamento.condicoes_pagamento|linebreaks }}</p>
        </div>

        <div class="validity-note">
          <strong>Devis valable jusqu'au : {{ orcamento.validade_orcamento|date:"d/m/Y" }}</strong>
        </div>
        <br />
        <div class="meta-group">
          <div class="meta-label">D√©lai d'ex√©cution</div>
          <div class="meta-value">{{ orcamento.prazo_execucao }} jours</div>
        </div>
        <br />
        <div class="meta-group">
          <div class="meta-label">Service</div>
          <div class="meta-value">{{ orcamento.solicitacao.get_tipo_servico_display }}</div>
        </div>

        <div class="totals-section">
          <div class="totals-box">
            <div class="total-row">
              <span>Total HT :</span>
              <span>{{ subtotal_ht|floatformat:2 }}‚Ç¨</span>
            </div>
            {% if remise_global > 0 %}
            <div class="total-row">
              <span>Remise ({{ remise_global }}%):</span>
              <span>-{{ valor_remise|floatformat:2 }}‚Ç¨</span>
            </div>
            <div class="total-row">
              <span>Sous-total apr√®s remise:</span>
              <span>{{ subtotal_apres_remise_ht|floatformat:2 }}‚Ç¨</span>
            </div>
            {% endif %}
            <div class="total-row">
              {% if taxa_tva_media == "Vari√°vel" %}
                <span>TVA ({{ taxa_tva_media }}) :</span>
              {% elif taxa_tva_media == "0" %}
                <span>TVA (Exon√©r√©e) :</span>
              {% else %}
                <span>TVA ({{ taxa_tva_media }}%) :</span>
              {% endif %}
              <span>{{ taxe_finale|floatformat:2 }}‚Ç¨</span>
            </div>
            <div class="total-row">
              <span>Total TTC :</span>
              <span>{{ subtotal_apres_remise_ttc|floatformat:2 }}‚Ç¨</span>
            </div>
            <div class="total-row">
              <span>Acompt√©s :</span>
              <span>0.00‚Ç¨</span>
            </div>
            <div class="total-row highlight">
              <span>Net √† Payer :</span>
              <span>{{ subtotal_apres_remise_ttc|floatformat:2 }}‚Ç¨</span>
            </div>
          </div>
        </div>

        <div style="text-align: right; font-size: 8pt; margin-top: 10px">
          Net √† payer {{ subtotal_apres_remise_ttc|currency_to_words }}.
        </div>
        {% else %}
        <div class="no-items-card">
          <div class="no-items-icon">üìã</div>
          <div class="no-items-title">Aucun √©l√©ment d√©taill√©</div>
          <div class="no-items-text">
            Les prestations d√©taill√©es seront pr√©cis√©es lors de la finalisation du devis.<br />
            Le montant final sera communiqu√© apr√®s √©tude compl√®te de votre projet.
          </div>
        </div>
        {% endif %}
        <div class="payment-info">
          <strong>TVA non applicable, article 293 B du CGI</strong><br />
          PAIEMENT PAR VIREMENT BANCAIRE : LOPES DE SOUZA FABIANO (EI) IBAN FR76 1027 8022 3400 0206
          6300 131
        </div>
      </div>
    </div>
    <script>
      // Enhanced functionality
      document.addEventListener('DOMContentLoaded', function () {
        // Print button
        const printBtn = document.querySelector('.print-btn');
        if (printBtn) {
          printBtn.addEventListener('click', function () {
            window.print();
          });
        }

        // Download HTML button
        window.downloadHTML = function () {
          const element = document.documentElement.outerHTML;
          const blob = new Blob([element], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download =
            'Devis_{{ orcamento.numero }}_{{ orcamento.solicitacao.nome_solicitante|slugify }}.html';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };
      });

      // Print optimization
      window.addEventListener('beforeprint', function () {
        document.title =
          'Devis_{{ orcamento.numero }}_{{ orcamento.solicitacao.nome_solicitante|slugify }}';
      });

      window.addEventListener('afterprint', function () {
        document.title = 'Devis {{ orcamento.numero }} - {{ company_info.name }}';
      });

      // Add smooth animations
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px',
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      }, observerOptions);

      // Observe elements for animation
      document.querySelectorAll('.section-title, .table-container, .totals-card').forEach((el) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
      });
    </script>
  </body>
</html>
