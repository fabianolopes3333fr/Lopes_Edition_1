{% extends 'base_dashboard.html' %}
{% block title %}Paramètres Système{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold text-gray-900 mb-8 flex items-center gap-3">
  <span class="w-12 h-12 flex items-center justify-center rounded-xl bg-gradient-to-br from-blue-50 to-green-50 text-green-600 shadow-inner"><i class="fas fa-sliders-h"></i></span>
  <span>Paramètres Système</span>
</h1>
<div class="bg-white border border-gray-200 rounded-2xl shadow-sm mb-10">
  <div class="border-b border-gray-100 px-6 pt-4 flex gap-2 flex-wrap" id="tabs">
    <button data-tab="auto" class="tab-btn px-5 py-2 rounded-t-lg bg-blue-600 text-white text-sm font-medium shadow">Auto-Entrepreneur</button>
    <button data-tab="interface" class="tab-btn px-5 py-2 rounded-t-lg bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Interface Logiciel</button>
    <button data-tab="email" class="tab-btn px-5 py-2 rounded-t-lg bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200">Email</button>
  </div>
  <div class="p-6 space-y-12">
    <!-- Auto -->
    <div id="tab-auto">
      <form method="post" class="space-y-8" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="auto" />
        
        <div class="flex items-center gap-2 mb-6">
          <h2 class="text-lg font-semibold text-blue-700 flex items-center gap-2">
            <i class="fas fa-briefcase"></i> Auto-Entrepreneur
          </h2>
          <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-600 font-medium">Régime Fiscal Simplifié</span>
        </div>

        <!-- Paramètres Généraux -->
        <div class="space-y-6">
          <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200">
            <i class="fas fa-cog text-gray-600"></i>
            Paramètres Généraux
          </h3>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label for="{{ auto_form.default_product_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-box text-gray-500 mr-1"></i>
                {{ auto_form.default_product_type.label }}
              </label>
              {{ auto_form.default_product_type }}
              <p class="mt-1 text-xs text-gray-500">Type de produit par défaut pour les nouveaux articles</p>
            </div>

            <div>
              <label for="{{ auto_form.declaration_periodicite.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-calendar-alt text-gray-500 mr-1"></i>
                {{ auto_form.declaration_periodicite.label }}
              </label>
              {{ auto_form.declaration_periodicite }}
              <p class="mt-1 text-xs text-gray-500">Fréquence de déclaration à l'URSSAF</p>
            </div>
          </div>
        </div>

        <!-- Activité Vente Fournitures (Biens) -->
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200 flex-1">
              <i class="fas fa-shopping-cart text-gray-600"></i>
              Activité Vente Fournitures (Biens)
            </h3>
            <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700 font-medium ml-3">Marchandises</span>
          </div>
          
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-2">
              <i class="fas fa-info-circle text-orange-600 mt-0.5"></i>
              <p class="text-xs text-gray-700">
                Ces taux s'appliquent aux ventes de fournitures, matériaux et marchandises.
                Les taux sont exprimés en pourcentage du chiffre d'affaires.
              </p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            {% for f in auto_form.visible_fields %}
              {% if 'biens_' in f.name %}
                <div>
                  <label for="{{ f.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-percentage text-gray-500 mr-1"></i>
                    {{ f.label }}
                  </label>
                  {{ f }}
                  <p class="mt-1 text-xs text-gray-500">
                    {% if 'cotisation_sociale' in f.name %}
                      Taux standard: 12.8%
                    {% elif 'imposition' in f.name %}
                      Taux standard: 1%
                    {% elif 'formation' in f.name %}
                      Taux standard: 0.1%
                    {% elif 'chambre' in f.name %}
                      Taux standard: 0.015%
                    {% endif %}
                  </p>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Total Biens -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-gray-700">
                <i class="fas fa-calculator text-gray-500 mr-2"></i>
                Total des charges (Biens)
              </span>
              <span class="text-lg font-bold text-blue-600" id="total-biens">--%</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">Somme de toutes les cotisations et taxes</p>
          </div>
        </div>

        <!-- Activité Vente Services (Main d'œuvre) -->
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200 flex-1">
              <i class="fas fa-tools text-gray-600"></i>
              Activité Vente Services (Main d'œuvre)
            </h3>
            <span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700 font-medium ml-3">Services</span>
          </div>
          
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-2">
              <i class="fas fa-info-circle text-green-600 mt-0.5"></i>
              <p class="text-xs text-gray-700">
                Ces taux s'appliquent aux prestations de services et à la main d'œuvre.
                Les taux sont généralement plus élevés que pour les marchandises.
              </p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            {% for f in auto_form.visible_fields %}
              {% if 'services_' in f.name %}
                <div>
                  <label for="{{ f.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-percentage text-gray-500 mr-1"></i>
                    {{ f.label }}
                  </label>
                  {{ f }}
                  <p class="mt-1 text-xs text-gray-500">
                    {% if 'cotisation_sociale' in f.name %}
                      Taux standard: 22%
                    {% elif 'imposition' in f.name %}
                      Taux standard: 1.7%
                    {% elif 'formation' in f.name %}
                      Taux standard: 0.2%
                    {% elif 'chambre' in f.name %}
                      Taux standard: 0.044%
                    {% endif %}
                  </p>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Total Services -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-gray-700">
                <i class="fas fa-calculator text-gray-500 mr-2"></i>
                Total des charges (Services)
              </span>
              <span class="text-lg font-bold text-green-600" id="total-services">--%</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">Somme de toutes les cotisations et taxes</p>
          </div>
        </div>

        <!-- Aide -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <i class="fas fa-lightbulb text-blue-600 text-lg mt-0.5"></i>
            <div class="space-y-2 text-sm text-gray-700">
              <p class="font-semibold text-blue-900">Information importante:</p>
              <ul class="space-y-1 text-xs">
                <li>• Les taux affichés sont les taux standards pour 2024</li>
                <li>• Vérifiez régulièrement les mises à jour de l'URSSAF</li>
                <li>• Le versement libératoire de l'impôt est optionnel</li>
                <li>• Ces paramètres sont utilisés pour calculer vos charges dans les devis</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Boutons -->
        <div class="pt-4 border-t border-gray-200 flex justify-end">
          <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
            <i class="fas fa-save mr-1"></i>
            Enregistrer
          </button>
        </div>
      </form>
    </div>

    <!-- Interface -->
    <div id="tab-interface" class="hidden">
      <form method="post" enctype="multipart/form-data" class="space-y-8">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="interface" />
        
        <div class="flex items-center gap-2 mb-6">
          <h2 class="text-lg font-semibold text-indigo-700 flex items-center gap-2">
            <i class="fas fa-desktop"></i> Interface Logiciel
          </h2>
          <span class="text-xs px-2 py-0.5 rounded bg-indigo-100 text-indigo-600 font-medium">Personnalisation</span>
        </div>

        <!-- Éléments Visuels -->
        <div class="space-y-6">
          <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200">
            <i class="fas fa-images text-gray-600"></i>
            Éléments Visuels
          </h3>
          
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4">
            <div class="flex items-start gap-2">
              <i class="fas fa-info-circle text-indigo-600 mt-0.5"></i>
              <p class="text-xs text-gray-700">
                Ces éléments seront utilisés dans l'interface du logiciel et sur les documents générés (devis, factures, etc.).
                Formats recommandés: PNG ou JPG. Taille maximale: 2 MB.
              </p>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-8">
            <!-- Logo -->
            <div class="space-y-4">
              <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <div class="mb-4">
                  <i class="fas fa-image text-gray-400 text-4xl"></i>
                </div>
                <label for="{{ interface_form.logo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-building text-indigo-500 mr-1"></i>
                  {{ interface_form.logo.label }}
                </label>
                {{ interface_form.logo }}
                
                {% if interface_form.instance.logo %}
                  <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-600 mb-2 font-medium">Aperçu actuel:</p>
                    <img src="{{ interface_form.instance.logo.url }}" alt="Logo actuel" class="h-20 mx-auto object-contain rounded shadow" />
                  </div>
                {% else %}
                  <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-xs text-yellow-800">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      Aucun logo configuré
                    </p>
                  </div>
                {% endif %}
              </div>
              
              <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-xs font-semibold text-gray-700 mb-2">
                  <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                  Conseils pour le logo:
                </p>
                <ul class="text-xs text-gray-600 space-y-1">
                  <li>• Dimensions recommandées: 300x100 pixels</li>
                  <li>• Fond transparent pour meilleur rendu</li>
                  <li>• Apparaît sur les en-têtes de documents</li>
                </ul>
              </div>
            </div>

            <!-- Image de Fond -->
            <div class="space-y-4">
              <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <div class="mb-4">
                  <i class="fas fa-panorama text-gray-400 text-4xl"></i>
                </div>
                <label for="{{ interface_form.background_image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-paint-brush text-indigo-500 mr-1"></i>
                  {{ interface_form.background_image.label }}
                </label>
                {{ interface_form.background_image }}
                
                {% if interface_form.instance.background_image %}
                  <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-600 mb-2 font-medium">Aperçu actuel:</p>
                    <img src="{{ interface_form.instance.background_image.url }}" alt="Image de fond actuelle" class="h-24 w-full mx-auto object-cover rounded shadow" />
                  </div>
                {% else %}
                  <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-xs text-yellow-800">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      Aucune image de fond configurée
                    </p>
                  </div>
                {% endif %}
              </div>
              
              <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-xs font-semibold text-gray-700 mb-2">
                  <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                  Conseils pour l'image de fond:
                </p>
                <ul class="text-xs text-gray-600 space-y-1">
                  <li>• Dimensions recommandées: 1920x1080 pixels</li>
                  <li>• Privilégier des tons clairs et subtils</li>
                  <li>• Utilisée dans certaines pages du système</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Aperçu -->
        <div class="space-y-4">
          <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200">
            <i class="fas fa-eye text-gray-600"></i>
            Aperçu de l'Application
          </h3>
          
          <div class="bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-6">
            <div class="bg-white rounded-lg shadow-lg p-4">
              <div class="flex items-center justify-between mb-4">
                {% if interface_form.instance.logo %}
                  <img src="{{ interface_form.instance.logo.url }}" alt="Logo" class="h-12 object-contain" />
                {% else %}
                  <div class="h-12 w-32 bg-gray-200 rounded flex items-center justify-center">
                    <span class="text-xs text-gray-500">Votre Logo</span>
                  </div>
                {% endif %}
                <div class="text-right">
                  <p class="text-sm font-bold text-gray-800">LOPES PEINTURE</p>
                  <p class="text-xs text-gray-500">Dashboard</p>
                </div>
              </div>
              <div class="border-t border-gray-200 pt-4">
                <p class="text-xs text-gray-600 text-center">
                  <i class="fas fa-info-circle mr-1"></i>
                  Aperçu simplifié de l'en-tête avec votre logo
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Boutons -->
        <div class="pt-4 border-t border-gray-200 flex justify-end">
          <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-medium shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
            <i class="fas fa-save mr-1"></i>
            Enregistrer
          </button>
        </div>
      </form>
    </div>

    <!-- Email -->
    <div id="tab-email" class="hidden">
      <form method="post" class="space-y-8">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="email" />
        
        <div class="flex items-center gap-2 mb-6">
          <h2 class="text-lg font-semibold text-green-700 flex items-center gap-2">
            <i class="fas fa-envelope"></i> Paramètres Email
          </h2>
          <span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-600 font-medium">Configuration SMTP</span>
        </div>

        <!-- Statut -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              {{ email_form.actif }}
              <label for="{{ email_form.actif.id_for_label }}" class="text-sm font-semibold text-gray-700 cursor-pointer">
                <i class="fas fa-toggle-on text-green-600 mr-1"></i>
                {{ email_form.actif.label }}
              </label>
            </div>
            <p class="text-xs text-gray-600 ml-auto">
              <i class="fas fa-info-circle"></i>
              Activez pour utiliser le serveur SMTP configuré
            </p>
          </div>
        </div>

        <!-- Configuration Serveur -->
        <div class="space-y-6">
          <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200">
            <i class="fas fa-server text-gray-600"></i>
            Configuration du Serveur
          </h3>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label for="{{ email_form.host.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-network-wired text-gray-500 mr-1"></i>
                {{ email_form.host.label }}
              </label>
              {{ email_form.host }}
              <p class="mt-1 text-xs text-gray-500">Ex: smtp.gmail.com, smtp.office365.com</p>
            </div>

            <div>
              <label for="{{ email_form.port.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-plug text-gray-500 mr-1"></i>
                {{ email_form.port.label }}
              </label>
              {{ email_form.port }}
              <p class="mt-1 text-xs text-gray-500">Port standard: 587 (TLS) ou 465 (SSL)</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-4">
                <i class="fas fa-shield-alt text-gray-500 mr-1"></i>
                Sécurité
              </label>
              <div class="space-y-3">
                <div class="flex items-center gap-2">
                  {{ email_form.use_tls }}
                  <label for="{{ email_form.use_tls.id_for_label }}" class="text-sm text-gray-700 cursor-pointer">
                    {{ email_form.use_tls.label }} <span class="text-xs text-gray-500">(Recommandé)</span>
                  </label>
                </div>
                <div class="flex items-center gap-2">
                  {{ email_form.use_ssl }}
                  <label for="{{ email_form.use_ssl.id_for_label }}" class="text-sm text-gray-700 cursor-pointer">
                    {{ email_form.use_ssl.label }}
                  </label>
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">
                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                N'utilisez pas TLS et SSL en même temps
              </p>
            </div>
          </div>
        </div>

        <!-- Authentification -->
        <div class="space-y-6">
          <h3 class="text-sm font-semibold text-gray-800 uppercase tracking-wide flex items-center gap-2 pb-2 border-b border-gray-200">
            <i class="fas fa-key text-gray-600"></i>
            Authentification
          </h3>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label for="{{ email_form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user text-gray-500 mr-1"></i>
                {{ email_form.username.label }}
              </label>
              {{ email_form.username }}
              <p class="mt-1 text-xs text-gray-500">Votre adresse email ou nom d'utilisateur</p>
            </div>

            <div>
              <label for="{{ email_form.password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-lock text-gray-500 mr-1"></i>
                {{ email_form.password.label }}
              </label>
              {{ email_form.password }}
              <p class="mt-1 text-xs text-gray-500">
                <i class="fas fa-info-circle"></i>
                Pour Gmail, utilisez un mot de passe d'application
              </p>
            </div>

            <div class="md:col-span-2">
              <label for="{{ email_form.from_email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-envelope-open-text text-gray-500 mr-1"></i>
                {{ email_form.from_email.label }}
              </label>
              {{ email_form.from_email }}
              <p class="mt-1 text-xs text-gray-500">Adresse email qui apparaîtra comme expéditeur</p>
            </div>
          </div>
        </div>

        <!-- Aide Configuration -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <i class="fas fa-lightbulb text-blue-600 text-lg mt-0.5"></i>
            <div class="space-y-2 text-sm text-gray-700">
              <p class="font-semibold text-blue-900">Exemples de configuration populaires:</p>
              <ul class="space-y-1 text-xs">
                <li><strong>Gmail:</strong> smtp.gmail.com | Port: 587 | TLS: Oui</li>
                <li><strong>Outlook/Office365:</strong> smtp.office365.com | Port: 587 | TLS: Oui</li>
                <li><strong>Yahoo:</strong> smtp.mail.yahoo.com | Port: 587 | TLS: Oui</li>
                <li><strong>OVH:</strong> ssl0.ovh.net | Port: 587 | TLS: Oui</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Boutons -->
        <div class="pt-4 border-t border-gray-200 flex justify-between items-center">
          <button type="button" onclick="testEmailConnection()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium text-sm transition flex items-center gap-2">
            <i class="fas fa-vial"></i>
            Tester la connexion
          </button>
          <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-medium shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
            <i class="fas fa-save mr-1"></i>
            Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const tabs = document.querySelectorAll('.tab-btn');
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('bg-blue-600','bg-indigo-600','bg-green-600','text-white','shadow'));
    tabs.forEach(b => b.classList.add('bg-gray-100','text-gray-700'));
    const tab = btn.dataset.tab;
    document.querySelectorAll('[id^="tab-"]').forEach(div => div.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.remove('hidden');
    btn.classList.remove('bg-gray-100','text-gray-700');
    if(tab==='auto'){ btn.classList.add('bg-blue-600','text-white','shadow'); }
    if(tab==='interface'){ btn.classList.add('bg-indigo-600','text-white','shadow'); }
    if(tab==='email'){ btn.classList.add('bg-green-600','text-white','shadow'); }
  }));

  // Função para testar conexão email
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  async function testEmailConnection() {
    const url = "{% url 'system_config:test_email' %}";
    const csrftoken = getCookie('csrftoken');
    const btn = event.currentTarget;
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test en cours...';
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
      const data = await res.json();
      if (res.ok && data.success) {
        alert(data.message || 'Test réussi.');
      } else {
        alert(data.message || 'Le test a échoué.');
      }
    } catch (e) {
      alert('Erreur inattendue: ' + e);
    } finally {
      btn.disabled = false;
      btn.innerHTML = original;
    }
  }

  // Calcular totais automaticamente
  function calculateTotals() {
    // Calcular total Biens
    const biensFields = ['biens_taux_cotisation_sociale', 'biens_taux_imposition', 'biens_taux_formation_pro', 'biens_taux_chambre_consulaire'];
    let totalBiens = 0;
    biensFields.forEach(field => {
      const input = document.querySelector(`input[name="${field}"]`);
      if(input && input.value) {
        totalBiens += parseFloat(input.value) || 0;
      }
    });
    const totalBiensEl = document.getElementById('total-biens');
    if(totalBiensEl) {
      totalBiensEl.textContent = totalBiens.toFixed(2) + '%';
    }

    // Calcular total Services
    const servicesFields = ['services_taux_cotisation_sociale', 'services_taux_imposition', 'services_taux_formation_pro', 'services_taux_chambre_consulaire'];
    let totalServices = 0;
    servicesFields.forEach(field => {
      const input = document.querySelector(`input[name="${field}"]`);
      if(input && input.value) {
        totalServices += parseFloat(input.value) || 0;
      }
    });
    const totalServicesEl = document.getElementById('total-services');
    if(totalServicesEl) {
      totalServicesEl.textContent = totalServices.toFixed(2) + '%';
    }
  }

  // Adicionar listeners para recalcular ao digitar
  document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
    
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
      input.addEventListener('input', calculateTotals);
    });
  });
</script>
{% endblock %}
