{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{{ action }} Client - LOPES PEINTURE{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Header da Página -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-user-edit text-white text-lg"></i>
                    </div>
                    {{ action }} Client
                </h1>
                {% if cliente %}
                <p class="text-gray-600 mt-1">Édition: {{ cliente.nom_complet }}</p>
                {% endif %}
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'clientes:lista_clientes' %}"
                   class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-4 py-3 rounded-lg font-medium flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-arrow-left"></i>
                    Retour à la liste
                </a>
                {% if cliente %}
                <a href="{% url 'clientes:detalhe_cliente' cliente.pk %}"
                   class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-lg font-medium flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-eye"></i>
                    Visualiser
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="post" id="clienteForm" class="space-y-6">
        {% csrf_token %}

        <!-- Navegação por Abas -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="border-b border-gray-200 bg-gradient-to-r from-gray-50 to-blue-50 rounded-t-lg">
                <nav class="flex overflow-x-auto" id="tab-nav">
                    <button type="button" class="tab-btn px-6 py-4 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 focus:outline-none focus:text-blue-600 focus:border-blue-500 transition-all duration-200 flex items-center gap-2 whitespace-nowrap" data-tab="principal">
                        <i class="fas fa-user text-blue-600"></i>
                        Informations Principales
                    </button>
                    {% if cliente %}
                    <button type="button" class="tab-btn px-6 py-4 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 focus:outline-none focus:text-blue-600 focus:border-blue-500 transition-all duration-200 flex items-center gap-2 whitespace-nowrap" data-tab="livraison">
                        <i class="fas fa-shipping-fast text-green-600"></i>
                        Adresses de Livraison
                    </button>
                   <!-- <button type="button" class="tab-btn px-6 py-4 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 focus:outline-none focus:text-blue-600 focus:border-blue-500 transition-all duration-200 flex items-center gap-2 whitespace-nowrap" data-tab="transporteur">
                        <i class="fas fa-truck text-purple-600"></i>
                        Transportadores
                    </button>
                    <button type="button" class="tab-btn px-6 py-4 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 focus:outline-none focus:text-blue-600 focus:border-blue-500 transition-all duration-200 flex items-center gap-2 whitespace-nowrap" data-tab="chantier">
                        <i class="fas fa-hard-hat text-orange-600"></i>
                        Endereços de Obra
                    </button>
                    <button type="button" class="tab-btn px-6 py-4 text-sm font-medium text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 focus:outline-none focus:text-blue-600 focus:border-blue-500 transition-all duration-200 flex items-center gap-2 whitespace-nowrap" data-tab="tva">
                        <i class="fas fa-percentage text-red-600"></i>
                        Tarifas TVA
                    </button>-->
                    {% endif %}
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <!-- Aba Principal -->
            <div class="tab-content p-6" id="tab-principal">
                <!-- Informações Básicas -->
                <div class="mb-8">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Informations de base</h3>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.code.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-hashtag text-gray-500 mr-1"></i>
                                    {{ form.code.label }}
                                </label>
                                {{ form.code }}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.civilite.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-user-tag text-gray-500 mr-1"></i>
                                        {{ form.civilite.label }}
                                    </label>
                                    {{ form.civilite }}
                                </div>
                                <div>
                                    <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-flag text-gray-500 mr-1"></i>
                                        {{ form.status.label }}
                                    </label>
                                    {{ form.status }}
                                </div>
                            </div>

                            <div>
                                <label for="{{ form.origem.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-source text-gray-500 mr-1"></i>
                                    {{ form.origem.label }}
                                </label>
                                {{ form.origem }}
                            </div>

                            <div>
                                <label for="{{ form.raison_sociale.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-building text-gray-500 mr-1"></i>
                                    {{ form.raison_sociale.label }}
                                </label>
                                {{ form.raison_sociale }}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.nom.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-user text-gray-500 mr-1"></i>
                                        {{ form.nom.label }} <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.nom }}
                                </div>
                                <div>
                                    <label for="{{ form.prenom.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-user text-gray-500 mr-1"></i>
                                        {{ form.prenom.label }}
                                    </label>
                                    {{ form.prenom }}
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-6 h-6 bg-red-100 rounded flex items-center justify-center">
                                    <i class="fas fa-map-marker-alt text-red-600 text-xs"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Adresse principale</h4>
                            </div>

                            <div>
                                <label for="{{ form.adresse.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-home text-gray-500 mr-1"></i>
                                    {{ form.adresse.label }} <span class="text-red-500">*</span>
                                </label>
                                {{ form.adresse }}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ form.code_postal.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-mail-bulk text-gray-500 mr-1"></i>
                                        {{ form.code_postal.label }} <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.code_postal }}
                                </div>
                                <div>
                                    <label for="{{ form.ville.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-city text-gray-500 mr-1"></i>
                                        {{ form.ville.label }} <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.ville }}
                                </div>
                            </div>

                            <div>
                                <label for="{{ form.pays.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe text-gray-500 mr-1"></i>
                                    {{ form.pays.label }}
                                </label>
                                {{ form.pays }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Contato -->
                <div class="mb-8">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-phone text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Coordonnées</h3>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.telephone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone text-gray-500 mr-1"></i>
                                    {{ form.telephone.label }}
                                </label>
                                {{ form.telephone }}
                            </div>
                            <div>
                                <label for="{{ form.mobile.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mobile-alt text-gray-500 mr-1"></i>
                                    {{ form.mobile.label }}
                                </label>
                                {{ form.mobile }}
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope text-gray-500 mr-1"></i>
                                    {{ form.email.label }}
                                </label>
                                {{ form.email }}
                            </div>
                            <div>
                                <label for="{{ form.url.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-link text-gray-500 mr-1"></i>
                                    {{ form.url.label }}
                                </label>
                                {{ form.url }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações Empresariais -->
                <div class="mb-8">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-building text-purple-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            Informations commerciales
                            <span class="text-sm font-normal text-gray-500 ml-2">(Facultatif)</span>
                        </h3>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.activite.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-briefcase text-gray-500 mr-1"></i>
                                    {{ form.activite.label }}
                                </label>
                                {{ form.activite }}
                            </div>
                            <div>
                                <label for="{{ form.siret.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card text-gray-500 mr-1"></i>
                                    {{ form.siret.label }}
                                </label>
                                {{ form.siret }}
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.code_ape.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-code text-gray-500 mr-1"></i>
                                    {{ form.code_ape.label }}
                                </label>
                                {{ form.code_ape }}
                            </div>
                            <div>
                                <label for="{{ form.tva_intra.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-percent text-gray-500 mr-1"></i>
                                    {{ form.tva_intra.label }}
                                </label>
                                {{ form.tva_intra }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Condições Comerciais e Observações -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Condições Comerciais -->
                    <div>
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-handshake text-orange-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Conditions commerciales</h3>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.taux_tva_defaut.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-percentage text-gray-500 mr-1"></i>
                                    {{ form.taux_tva_defaut.label }}
                                </label>
                                {{ form.taux_tva_defaut }}
                            </div>
                            <div>
                                <label for="{{ form.remise_globale.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-tag text-gray-500 mr-1"></i>
                                    {{ form.remise_globale.label }}
                                </label>
                                {{ form.remise_globale }}
                            </div>
                            <div>
                                <label for="{{ form.conditions_paiement.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card text-gray-500 mr-1"></i>
                                    {{ form.conditions_paiement.label }}
                                </label>
                                {{ form.conditions_paiement }}
                            </div>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div>
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sticky-note text-yellow-600"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Observations</h3>
                        </div>

                        <div>
                            <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment text-gray-500 mr-1"></i>
                                {{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
            </div>

            {% if cliente and livraison_formset %}
            <!-- Aba Endereços de Entrega -->
            <div class="tab-content p-6 hidden" id="tab-livraison">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shipping-fast text-green-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Infos Supp</h3>
                    <button type="button" onclick="addNewLivraisonForm()" class="ml-auto bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Ajouter une Adresse
                    </button>
                </div>

                {{ livraison_formset.management_form }}
                <div id="livraison-formset" class="space-y-6">
                    {% for form in livraison_formset %}
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 transition-all duration-200 hover:shadow-md formset-item" data-formset-item>
                        {{ form.id }}
                        {% if form.DELETE %}
                            {{ form.DELETE }}
                        {% endif %}

                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                                <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                                    <i class="fas fa-truck text-green-600 text-xs"></i>
                                </div>
                                Adresse de livraison #{{ forloop.counter }}
                            </h4>
                            <div class="flex items-center gap-2">
                                <button type="button" onclick="copyMainAddressToForm(this)" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1">
                                    <i class="fas fa-copy text-xs"></i>
                                    Copier l'adresse principale
                                </button>
                                {% if form.instance.pk %}
                                <button type="button" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1" onclick="deleteFormsetItem(this)">
                                    <i class="fas fa-trash text-xs"></i>
                                    Retirer
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.nom.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-tag text-gray-500 mr-1"></i>
                                    {{ form.nom.label }}
                                </label>
                                {{ form.nom }}
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                                    {{ form.copier_adresse_principale }}
                                    {{ form.copier_adresse_principale.label }}
                                </label>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label for="{{ form.adresse.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-home text-gray-500 mr-1"></i>
                                {{ form.adresse.label }}
                            </label>
                            {{ form.adresse }}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                            <div>
                                <label for="{{ form.code_postal.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-mail-bulk text-gray-500 mr-1"></i>
                                    {{ form.code_postal.label }}
                                </label>
                                {{ form.code_postal }}
                            </div>
                            <div>
                                <label for="{{ form.ville.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-city text-gray-500 mr-1"></i>
                                    {{ form.ville.label }}
                                </label>
                                {{ form.ville }}
                            </div>
                            <div>
                                <label for="{{ form.pays.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-globe text-gray-500 mr-1"></i>
                                    {{ form.pays.label }}
                                </label>
                                {{ form.pays }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label for="{{ form.contact_nom.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user text-gray-500 mr-1"></i>
                                    {{ form.contact_nom.label }}
                                </label>
                                {{ form.contact_nom }}
                            </div>
                            <div>
                                <label for="{{ form.contact_telephone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone text-gray-500 mr-1"></i>
                                    {{ form.contact_telephone.label }}
                                </label>
                                {{ form.contact_telephone }}
                            </div>
                        </div>

                        <div class="mt-6">
                            <label for="{{ form.instructions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment text-gray-500 mr-1"></i>
                                {{ form.instructions.label }}
                            </label>
                            {{ form.instructions }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Outras abas existentes... -->

        </div>

        <!-- Botões de Ação -->
        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-200">
            <a href="{% url 'clientes:lista_clientes' %}"
               class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-all duration-200 text-center border border-gray-300">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </a>
            <button type="submit"
                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-8 py-3 rounded-lg font-medium flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                <i class="fas fa-save"></i>
                Enregistrer les modifications
            </button>
        </div>
    </form>
</div>

<style>
/* Estilização para todos os inputs, selects e textareas do Django */
input[type="text"],
input[type="email"],
input[type="url"],
input[type="tel"],
input[type="number"],
input[type="checkbox"],
select,
textarea {
    width: 100% !important;
    padding: 0.75rem 1rem !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.5rem !important;
    transition: all 0.3s ease !important;
    background: white !important;
    font-size: 0.875rem !important;
}

input[type="checkbox"] {
    width: auto !important;
    margin-right: 0.5rem !important;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="url"]:focus,
input[type="tel"]:focus,
input[type="number"]:focus,
select:focus,
textarea:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    background: #fefefe !important;
}

input[type="text"]:hover,
input[type="email"]:hover,
input[type="url"]:hover,
input[type="tel"]:hover,
input[type="number"]:hover,
select:hover,
textarea:hover {
    border-color: #9ca3af !important;
}

textarea {
    min-height: 120px !important;
    resize: vertical !important;
}

.tab-btn.active {
    color: #3b82f6 !important;
    border-bottom-color: #3b82f6 !important;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1)) !important;
}

.formset-item.deleted {
    opacity: 0.5;
    background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
    border-color: #f87171 !important;
}
</style>

<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    // Set first tab as active
    if (tabButtons.length > 0) {
        tabButtons[0].classList.add('active');
        if (tabContents.length > 0) {
            tabContents[0].classList.remove('hidden');
        }
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Remove active class from all tabs
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));

            // Add active class to clicked tab
            this.classList.add('active');
            const targetTab = document.getElementById(`tab-${tabId}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
        });
    });
});

// Função para copiar endereço principal para o formulário de entrega
function copyMainAddressToForm(button) {
    const formsetItem = button.closest('.formset-item');

    // Obter dados do endereço principal do cliente
    const adresseField = document.querySelector('[name="adresse"]');
    const codePostalField = document.querySelector('[name="code_postal"]');
    const villeField = document.querySelector('[name="ville"]');
    const paysField = document.querySelector('[name="pays"]');

    if (adresseField && codePostalField && villeField && paysField) {
        // Preencher os campos do formset
        const targetAdresse = formsetItem.querySelector('[name*="-adresse"]');
        const targetCodePostal = formsetItem.querySelector('[name*="-code_postal"]');
        const targetVille = formsetItem.querySelector('[name*="-ville"]');
        const targetPays = formsetItem.querySelector('[name*="-pays"]');

        if (targetAdresse) targetAdresse.value = adresseField.value;
        if (targetCodePostal) targetCodePostal.value = codePostalField.value;
        if (targetVille) targetVille.value = villeField.value;
        if (targetPays) targetPays.value = paysField.value;

        // Visual feedback
        button.innerHTML = '<i class="fas fa-check text-xs"></i> Copiado!';
        button.classList.remove('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
        button.classList.add('from-green-500', 'to-green-600');

        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy text-xs"></i> Copiar Endereço Principal';
            button.classList.remove('from-green-500', 'to-green-600');
            button.classList.add('from-blue-500', 'to-blue-600', 'hover:from-blue-600', 'hover:to-blue-700');
        }, 2000);
    }
}

// Adicionar novo formulário de entrega
function addNewLivraisonForm() {
    const formsetDiv = document.getElementById('livraison-formset');
    const totalFormsInput = document.querySelector('[name="livraison-TOTAL_FORMS"]');

    if (totalFormsInput && formsetDiv) {
        const formCount = parseInt(totalFormsInput.value);
        const newFormIndex = formCount;

        // Template do novo formulário
        const newFormHTML = `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 transition-all duration-200 hover:shadow-md formset-item" data-formset-item>
                <input type="hidden" name="livraison-${newFormIndex}-id" id="id_livraison-${newFormIndex}-id">
                <input type="hidden" name="livraison-${newFormIndex}-DELETE" id="id_livraison-${newFormIndex}-DELETE">

                <div class="flex justify-between items-center mb-6">
                    <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                        <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                            <i class="fas fa-truck text-green-600 text-xs"></i>
                        </div>
                        Adresse de livraison #${newFormIndex + 1}
                    </h4>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="copyMainAddressToForm(this)" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1">
                            <i class="fas fa-copy text-xs"></i>
                            Copier l'adresse principale
                        </button>
                        <button type="button" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1" onclick="deleteFormsetItem(this)">
                            <i class="fas fa-trash text-xs"></i>
                            Retirer
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="id_livraison-${newFormIndex}-nom" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag text-gray-500 mr-1"></i>
                            Nome do endereço
                        </label>
                        <input type="text" name="livraison-${newFormIndex}-nom" id="id_livraison-${newFormIndex}-nom" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex items-center">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
                            <input type="checkbox" name="livraison-${newFormIndex}-copier_adresse_principale" id="id_livraison-${newFormIndex}-copier_adresse_principale">
                            Copier adresse principale
                        </label>
                    </div>
                </div>

                <div class="mt-6">
                    <label for="id_livraison-${newFormIndex}-adresse" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-home text-gray-500 mr-1"></i>
                        Endereço
                    </label>
                    <textarea name="livraison-${newFormIndex}-adresse" id="id_livraison-${newFormIndex}-adresse" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div>
                        <label for="id_livraison-${newFormIndex}-code_postal" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-mail-bulk text-gray-500 mr-1"></i>
                            CEP
                        </label>
                        <input type="text" name="livraison-${newFormIndex}-code_postal" id="id_livraison-${newFormIndex}-code_postal" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="id_livraison-${newFormIndex}-ville" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-city text-gray-500 mr-1"></i>
                            Cidade
                        </label>
                        <input type="text" name="livraison-${newFormIndex}-ville" id="id_livraison-${newFormIndex}-ville" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="id_livraison-${newFormIndex}-pays" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-globe text-gray-500 mr-1"></i>
                            País
                        </label>
                        <input type="text" name="livraison-${newFormIndex}-pays" id="id_livraison-${newFormIndex}-pays" value="França" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="id_livraison-${newFormIndex}-contact_nom" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user text-gray-500 mr-1"></i>
                            Nome do contato
                        </label>
                        <input type="text" name="livraison-${newFormIndex}-contact_nom" id="id_livraison-${newFormIndex}-contact_nom" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="id_livraison-${newFormIndex}-contact_telephone" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone text-gray-500 mr-1"></i>
                            Telefone do contato
                        </label>
                        <input type="tel" name="livraison-${newFormIndex}-contact_telephone" id="id_livraison-${newFormIndex}-contact_telephone" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="mt-6">
                    <label for="id_livraison-${newFormIndex}-instructions" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment text-gray-500 mr-1"></i>
                        Instruções de entrega
                    </label>
                    <textarea name="livraison-${newFormIndex}-instructions" id="id_livraison-${newFormIndex}-instructions" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>
        `;

        // Adicionar o novo formulário
        formsetDiv.insertAdjacentHTML('beforeend', newFormHTML);

        // Atualizar o contador de formulários
        totalFormsInput.value = formCount + 1;

        // Scroll suave para o novo formulário
        const newForm = formsetDiv.lastElementChild;
        newForm.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Feedback visual
        newForm.style.opacity = '0';
        newForm.style.transform = 'translateY(20px)';
        setTimeout(() => {
            newForm.style.transition = 'all 0.3s ease';
            newForm.style.opacity = '1';
            newForm.style.transform = 'translateY(0)';
        }, 100);

        console.log('Novo formulário de entrega adicionado:', newFormIndex);
    }
}

// Função para remover formulário de entrega
function deleteFormsetItem(button) {
    const formsetItem = button.closest('.formset-item');
    const deleteInput = formsetItem.querySelector('[name*="-DELETE"]');

    if (deleteInput) {
        // Se o item já existe no banco (tem ID), marcar para deletar
        const idInput = formsetItem.querySelector('[name*="-id"]');
        if (idInput && idInput.value) {
            deleteInput.checked = true;
            formsetItem.classList.add('deleted');
            formsetItem.style.display = 'none';
        } else {
            // Se é um item novo, remover completamente
            formsetItem.remove();
            updateFormsetIndexes();
        }
    }
}

// Função para reorganizar índices após remoção
function updateFormsetIndexes() {
    const formsetDiv = document.getElementById('livraison-formset');
    const totalFormsInput = document.querySelector('[name="livraison-TOTAL_FORMS"]');
    const formsetItems = formsetDiv.querySelectorAll('.formset-item:not(.deleted)');

    formsetItems.forEach((item, index) => {
        // Atualizar todos os nomes e IDs dos campos
        const inputs = item.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/livraison-\d+-/, `livraison-${index}-`);
            }
            if (input.id) {
                input.id = input.id.replace(/id_livraison-\d+-/, `id_livraison-${index}-`);
            }
        });

        // Atualizar labels
        const labels = item.querySelectorAll('label');
        labels.forEach(label => {
            if (label.getAttribute('for')) {
                label.setAttribute('for', label.getAttribute('for').replace(/id_livraison-\d+-/, `id_livraison-${index}-`));
            }
        });

        // Atualizar título do formulário
        const title = item.querySelector('h4');
        if (title) {
            title.innerHTML = title.innerHTML.replace(/Adresse de livraison #\d+/, `Adresse de livraison #${index + 1}`);
        }
    });

    if (totalFormsInput) {
        totalFormsInput.value = formsetItems.length;
    }
}

// Função para mostrar/ocultar campo customizado de TVA Intracomunautária
function toggleTvaIntraCustom(selectElement) {
    const customField = document.getElementById('tva-intra-custom-field');
    const customInput = document.querySelector('[name="tva_intra_custom"]');

    if (selectElement.value === 'autre') {
        customField.style.display = 'block';
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customField.style.display = 'none';
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

// Inicializar o estado do campo customizado ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar estado inicial do campo TVA Intracomunautária
    const tvaIntraSelect = document.querySelector('[name="tva_intra"]');
    if (tvaIntraSelect) {
        toggleTvaIntraCustom(tvaIntraSelect);

        // Verificar se já existe valor no campo customizado
        const customInput = document.querySelector('[name="tva_intra_custom"]');
        if (customInput && customInput.value && tvaIntraSelect.value === 'autre') {
            const customField = document.getElementById('tva-intra-custom-field');
            if (customField) {
                customField.style.display = 'block';
                customInput.style.display = 'block';
            }
        }
    }
});
</script>
{% endblock %}
