{% extends 'accounts/base_auth.html' %}
{% load static %}

{% block title %}Nouveau mot de passe - Lopes Peinture{% endblock %}

{% block content %}
<div class="w-full max-w-md space-y-8">
  {% if validlink %}
    <!-- Header -->
    <div class="text-center">
      <div class="mx-auto h-20 w-20 bg-gradient-to-r from-teal-600 to-cyan-600 rounded-full flex items-center justify-center mb-6 shadow-lg animate-pulse-slow">
        <i class="fas fa-lock text-white text-2xl"></i>
      </div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2 animate-slide-up">Nouveau mot de passe</h2>
      <p class="text-gray-600 animate-fade-in leading-relaxed">
        Choisissez un mot de passe fort et sécurisé pour votre compte.
      </p>
    </div>

    <!-- Form Errors -->
    {% if form.errors %}
    <div class="rounded-xl p-4 bg-red-50 border border-red-200 text-red-800 animate-slide-up" role="alert">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>
        </div>
        <div class="ml-3 flex-1">
          <div class="font-semibold mb-2">Erreurs de validation :</div>
          <ul class="text-sm space-y-1">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
              <li class="flex items-center">
                <i class="fas fa-circle text-xs mr-2"></i>{{ error }}
              </li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Formulaire -->
    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 animate-slide-up">
      <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Nouveau mot de passe -->
        <div class="space-y-2">
          <label
            for="{{ form.new_password1.id_for_label }}"
            class="block text-sm font-semibold text-gray-700"
          >
            <i class="fas fa-key mr-2 text-brand-primary"></i>
            Nouveau mot de passe <span class="text-red-500 ml-1">*</span>
          </label>
          <div class="relative">
            <input
              type="password"
              id="{{ form.new_password1.id_for_label }}"
              name="{{ form.new_password1.html_name }}"
              placeholder="Votre nouveau mot de passe"
              autocomplete="new-password"
              required
              class="w-full pl-12 pr-12 py-3 text-gray-900 bg-white border-2 border-gray-300 rounded-xl shadow-sm placeholder-gray-500 focus:outline-none focus:ring-0 focus:border-brand-primary transition-all duration-200 hover:border-gray-400 {% if form.new_password1.errors %}border-red-500{% endif %}"
            />
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-key text-gray-400"></i>
            </div>
            <button
              type="button"
              onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)"
              class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none transition-colors duration-200"
            >
              <i class="fas fa-eye"></i>
              <span class="sr-only">Afficher le mot de passe</span>
            </button>
          </div>
          {% if form.new_password1.errors %}
          <div class="mt-2 text-sm text-red-600">
            {% for error in form.new_password1.errors %}
            <p class="flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
            </p>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Confirmer nouveau mot de passe -->
        <div class="space-y-2">
          <label
            for="{{ form.new_password2.id_for_label }}"
            class="block text-sm font-semibold text-gray-700"
          >
            <i class="fas fa-check-circle mr-2 text-brand-primary"></i>
            Confirmer le nouveau mot de passe <span class="text-red-500 ml-1">*</span>
          </label>
          <div class="relative">
            <input
              type="password"
              id="{{ form.new_password2.id_for_label }}"
              name="{{ form.new_password2.html_name }}"
              placeholder="Confirmer votre nouveau mot de passe"
              autocomplete="new-password"
              required
              class="w-full pl-12 pr-12 py-3 text-gray-900 bg-white border-2 border-gray-300 rounded-xl shadow-sm placeholder-gray-500 focus:outline-none focus:ring-0 focus:border-brand-primary transition-all duration-200 hover:border-gray-400 {% if form.new_password2.errors %}border-red-500{% endif %}"
            />
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-check-circle text-gray-400"></i>
            </div>
            <button
              type="button"
              onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)"
              class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none transition-colors duration-200"
            >
              <i class="fas fa-eye"></i>
              <span class="sr-only">Afficher le mot de passe</span>
            </button>
          </div>
          {% if form.new_password2.errors %}
          <div class="mt-2 text-sm text-red-600">
            {% for error in form.new_password2.errors %}
            <p class="flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>{{ error }}
            </p>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Password Requirements -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
          <h4 class="text-sm font-semibold text-blue-800 mb-3">
            <i class="fas fa-shield-alt mr-2"></i>
            Exigences du mot de passe
          </h4>
          <ul class="text-sm text-blue-700 space-y-1">
            <li class="flex items-center">
              <i class="fas fa-check-circle text-blue-600 mr-2 text-xs"></i>
              Au moins 8 caractères
            </li>
            <li class="flex items-center">
              <i class="fas fa-check-circle text-blue-600 mr-2 text-xs"></i>
              Au moins une lettre majuscule et minuscule
            </li>
            <li class="flex items-center">
              <i class="fas fa-check-circle text-blue-600 mr-2 text-xs"></i>
              Au moins un chiffre
            </li>
          </ul>
        </div>

        <!-- Submit Button -->
        <div class="space-y-4 pt-4">
          <button
            type="submit"
            class="group relative w-full flex justify-center items-center py-4 px-6 text-white font-semibold text-base rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-brand-primary focus:ring-opacity-50 disabled:opacity-60 disabled:cursor-not-allowed transition-all duration-200 btn-primary transform hover:scale-[1.02] active:scale-[0.98]"
          >
            <i class="fas fa-save mr-3 text-white/90 group-hover:text-white transition-colors duration-200"></i>
            Définir le nouveau mot de passe
          </button>
        </div>
      </form>

      <!-- Login Link -->
      <div class="text-center mt-8 pt-6 border-t border-gray-200">
        <a
          href="{% url 'accounts:login' %}"
          class="inline-flex items-center text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors duration-200"
        >
          <i class="fas fa-arrow-left mr-2"></i>
          Retour à la connexion
        </a>
      </div>
    </div>

  {% else %}
    <!-- Invalid Link -->
    <div class="text-center">
      <div class="mx-auto h-20 w-20 bg-gradient-to-r from-red-600 to-pink-600 rounded-full flex items-center justify-center mb-6 shadow-lg animate-pulse-slow">
        <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
      </div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2 animate-slide-up">Lien invalide</h2>
      <p class="text-gray-600 animate-fade-in leading-relaxed mb-8">
        Le lien de réinitialisation est invalide ou a expiré.
      </p>

      <div class="bg-red-50 border border-red-200 rounded-xl p-6 animate-slide-up mb-8">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <i class="fas fa-times-circle text-red-500 text-2xl"></i>
          </div>
          <div class="ml-4 flex-1 text-left">
            <h3 class="text-lg font-semibold text-red-800 mb-3">Que s'est-il passé ?</h3>
            <div class="text-sm text-red-700 space-y-2">
              <p>• Le lien a peut-être expiré (valide 24h)</p>
              <p>• Le lien a déjà été utilisé</p>
              <p>• L'adresse URL est incorrecte</p>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <a
          href="{% url 'accounts:password_reset' %}"
          class="group relative w-full flex justify-center items-center py-4 px-6 text-white font-semibold text-base rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-brand-primary focus:ring-opacity-50 transition-all duration-200 btn-primary transform hover:scale-[1.02] active:scale-[0.98]"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-4">
            <i class="fas fa-redo text-white/80 group-hover:text-white transition-colors duration-200"></i>
          </span>
          Demander un nouveau lien
        </a>

        <a
          href="{% url 'accounts:login' %}"
          class="group relative w-full flex justify-center items-center py-3 px-6 bg-gray-100 text-gray-700 font-medium text-sm rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-4">
            <i class="fas fa-arrow-left text-gray-500 group-hover:text-gray-700 transition-colors duration-200"></i>
          </span>
          Retour à la connexion
        </a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block navigation_links %}
<div class="text-center space-y-6">
  <div class="p-6 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-xl shadow-sm">
    <p class="text-teal-800 font-medium mb-3">
      <i class="fas fa-lightbulb mr-2 text-teal-600" aria-hidden="true"></i>
      Conseils pour un mot de passe sécurisé
    </p>
    <div class="text-sm text-gray-600 space-y-2">
      <p>Utilisez une combinaison de lettres, chiffres et symboles pour créer un mot de passe fort.</p>
      <p>Évitez d'utiliser des informations personnelles facilement devinables.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Toggle password visibility
  function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');

    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  }

  // Auto-focus no primeiro input
  document.addEventListener('DOMContentLoaded', function () {
    const firstInput = document.querySelector('input[type="password"]');
    if (firstInput) {
      firstInput.focus();
    }
  });

  // Validação de senha em tempo real
  document.addEventListener('DOMContentLoaded', function () {
    const password1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const password2 = document.getElementById('{{ form.new_password2.id_for_label }}');

    if (password1 && password2) {
      function validatePasswords() {
        if (password2.value && password1.value !== password2.value) {
          password2.classList.add('border-red-500');
        } else {
          password2.classList.remove('border-red-500');
        }
      }

      password1.addEventListener('input', validatePasswords);
      password2.addEventListener('input', validatePasswords);
    }
  });
</script>
{% endblock %}
