{% extends 'base_dashboard.html' %} {% load static %} {% block title %}Modifier mon Profil - {{
user.get_full_name }} - {{ block.super }}{% endblock %} {% block extra_css %}
<style>
  /* Mantém somente estilos essenciais dos campos */
  .form-field { position: relative; margin-bottom: 1.5rem; }
  .form-field .field-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; z-index: 10; pointer-events: none; }
  .form-field.has-textarea .field-icon { top: 1rem; transform: none; }
  .form-input { width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; background-color: white; }
  .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
  .form-input.error { border-color: #ef4444; }
</style>
{% endblock %} {% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Header -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a
          href="{% url 'profiles:detail' %}"
          class="text-gray-500 hover:text-gray-700 transition-colors"
        >
          <i class="fas fa-arrow-left text-lg"></i>
        </a>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Modifier mon Profil</h1>
          <p class="text-gray-600 mt-1">Mettez à jour vos informations personnelles</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <span class="text-sm text-gray-600">
          Complétude: <strong>{{ completion_percentage }}%</strong>
        </span>
        <a
          href="{% url 'profiles:detail' %}"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
        >
          <i class="fas fa-eye mr-2"></i>
          Voir le profil
        </a>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mb-6">
    {% for message in messages %}
    <div
      class="rounded-lg p-4 mb-4 {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}"
    >
      <div class="flex items-center">
        <i
          class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-2"
        ></i>
        {{ message }}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Formulário -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <form method="post" enctype="multipart/form-data" class="space-y-8" novalidate>
      {% csrf_token %}

     

      <!-- ✅ Seção: Photo de profil -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-camera mr-3 text-blue-600"></i>
            Photo de profil
          </h2>
          <p class="mt-1 text-sm text-gray-600">Ajoutez une photo pour personnaliser votre profil</p>
        </div>

        <div class="p-6">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
            <!-- Avatar atual -->
            <div class="flex-shrink-0">
              {% if profile.avatar %}
              <img id="avatar-preview" class="avatar-preview h-24 w-24 rounded-full object-cover border-4 border-gray-200 shadow" src="{{ profile.avatar.url }}" alt="{{ user.get_full_name }}" />
              {% else %}
              <div id="avatar-preview" class="avatar-placeholder h-24 w-24 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 text-white text-2xl font-semibold shadow">
                {{ profile.initials }}
              </div>
              {% endif %}
            </div>

            <!-- Upload / Dropzone -->
            <div class="flex-1 w-full">
              <div class="hidden">{{ form.avatar }}</div>
              <label for="{{ form.avatar.id_for_label }}" id="avatar-dropzone" class="cursor-pointer w-full border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center gap-3 text-center hover:border-blue-400 hover:bg-blue-50 transition">
                <i class="fas fa-cloud-upload-alt text-3xl text-blue-500"></i>
                <span class="text-sm font-medium text-gray-700">Cliquez ou déposez une image</span>
                <span class="text-xs text-gray-500">JPG, PNG ou GIF • Max 2MB</span>
              </label>
              <p id="avatar-file-name" class="mt-2 text-xs text-gray-500"></p>

              {% if form.avatar.errors %}
              <div class="mt-2 text-sm text-red-600">
                {% for error in form.avatar.errors %}
                <p class="flex items-center"><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</p>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Seção: Informations de contact -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-address-book mr-3 text-blue-600"></i>
            Informations de contact
          </h2>
          <p class="mt-1 text-sm text-gray-600">Vos coordonnées pour faciliter la communication</p>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Téléphone -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.phone.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-phone mr-2 text-blue-500"></i>
                {{ form.phone.label }} {% if form.phone.field.required %}<span class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                
                <input
                  type="tel"
                  id="{{ form.phone.id_for_label }}"
                  name="{{ form.phone.html_name }}"
                  value="{{ form.phone.value|default:'' }}"
                  placeholder="{{ form.phone.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.phone.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.phone.errors %}error{% endif %}"
                />
              </div>

              {% if form.phone.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.phone.help_text }}</p>
              {% endif %} {% if form.phone.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.phone.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Adresse -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.address.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                {{ form.address.label }} {% if form.address.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field has-textarea">
                
                <textarea
                  id="{{ form.address.id_for_label }}"
                  name="{{ form.address.html_name }}"
                  placeholder="{{ form.address.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.address.field.widget.attrs.autocomplete }}"
                  rows="3"
                  class="form-input {% if form.address.errors %}error{% endif %}"
                >
{{ form.address.value|default:'' }}</textarea
                >
              </div>

              {% if form.address.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.address.help_text }}</p>
              {% endif %} {% if form.address.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.address.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Ville -->
            <div>
              <label
                for="{{ form.city.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-city mr-2 text-blue-500"></i>
                {{ form.city.label }} {% if form.city.field.required %}<span class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                
                <input
                  type="text"
                  id="{{ form.city.id_for_label }}"
                  name="{{ form.city.html_name }}"
                  value="{{ form.city.value|default:'' }}"
                  placeholder="{{ form.city.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.city.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.city.errors %}error{% endif %}"
                />
              </div>

              {% if form.city.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.city.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Code postal -->
            <div>
              <label
                for="{{ form.postal_code.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-mail-bulk mr-2 text-blue-500"></i>
                {{ form.postal_code.label }} {% if form.postal_code.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                
                <input
                  type="text"
                  id="{{ form.postal_code.id_for_label }}"
                  name="{{ form.postal_code.html_name }}"
                  value="{{ form.postal_code.value|default:'' }}"
                  placeholder="{{ form.postal_code.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.postal_code.field.widget.attrs.autocomplete }}"
                  maxlength="5"
                  pattern="[0-9]{5}"
                  class="form-input {% if form.postal_code.errors %}error{% endif %}"
                />
              </div>

              {% if form.postal_code.help_text %}
              <p class="mt-1 text-xs text-gray-500">{{ form.postal_code.help_text }}</p>
              {% endif %} {% if form.postal_code.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.postal_code.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Pays -->
            <div class="lg:col-span-2">
              <label
                for="{{ form.country.id_for_label }}"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                <i class="fas fa-flag mr-2 text-blue-500"></i>
                {{ form.country.label }} {% if form.country.field.required %}<span
                  class="text-red-500"
                  >*</span
                >{% endif %}
              </label>

              <div class="form-field">
                
                <input
                  type="text"
                  id="{{ form.country.id_for_label }}"
                  name="{{ form.country.html_name }}"
                  value="{{ form.country.value|default:'' }}"
                  placeholder="{{ form.country.field.widget.attrs.placeholder }}"
                  autocomplete="{{ form.country.field.widget.attrs.autocomplete }}"
                  class="form-input {% if form.country.errors %}error{% endif %}"
                />
              </div>

              {% if form.country.errors %}
              <div class="mt-1 text-sm text-red-600">
                {% for error in form.country.errors %}
                <p class="flex items-center">
                  <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                </p>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Seção: Préférences -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-cog mr-3 text-blue-600"></i>
            Préférences de communication
          </h2>
          <p class="mt-1 text-sm text-gray-600">Gérez vos notifications et communications</p>
        </div>

        <div class="p-6">
          <div class="space-y-4">
            <!-- Notifications -->
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
            >
              <div class="flex items-center">
                <i class="fas fa-bell text-blue-500 mr-3"></i>
                <div>
                  <label
                    for="{{ form.receive_notifications.id_for_label }}"
                    class="text-sm font-medium text-gray-900 cursor-pointer"
                  >
                    {{ form.receive_notifications.label }}
                  </label>
                  <p class="text-sm text-gray-500">{{ form.receive_notifications.help_text }}</p>
                </div>
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="{{ form.receive_notifications.id_for_label }}"
                  name="{{ form.receive_notifications.html_name }}"
                  {%
                  if
                  form.receive_notifications.value
                  %}checked{%
                  endif
                  %}
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded transition-colors"
                />
              </div>
            </div>

            <!-- Newsletter -->
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
            >
              <div class="flex items-center">
                <i class="fas fa-newspaper text-blue-500 mr-3"></i>
                <div>
                  <label
                    for="{{ form.receive_newsletters.id_for_label }}"
                    class="text-sm font-medium text-gray-900 cursor-pointer"
                  >
                    {{ form.receive_newsletters.label }}
                  </label>
                  <p class="text-sm text-gray-500">{{ form.receive_newsletters.help_text }}</p>
                </div>
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="{{ form.receive_newsletters.id_for_label }}"
                  name="{{ form.receive_newsletters.html_name }}"
                  {%
                  if
                  form.receive_newsletters.value
                  %}checked{%
                  endif
                  %}
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded transition-colors"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ Botões de ação -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6">
          <div
            class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4"
          >
            <!-- Informações -->
            <div class="flex items-center text-sm text-gray-600">
              <i class="fas fa-info-circle mr-2 text-blue-500"></i>
              <span>Toutes les modifications sont sauvegardées instantanément</span>
            </div>

            <!-- Botões -->
            <div class="flex items-center space-x-3">
              <a
                href="{% url 'profiles:detail' %}"
                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
              >
                <i class="fas fa-times mr-2"></i>
                Annuler
              </a>

              <!-- ✅ SUBSTITUIR O BOTÃO EXISTENTE POR ESTE: -->
              <div class="flex justify-end">
                <!-- Botão básico sem classes especiais -->
                <input
                  type="submit"
                  id="submit-button"
                  value="Enregistrer les modifications"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 cursor-pointer flex items-center gap-2"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- ✅ Seção de ajuda -->
    <div class="mt-8 bg-blue-50 rounded-xl border border-blue-200 p-6">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-lightbulb text-blue-600 text-xl"></i>
        </div>
        <div class="ml-4">
          <h3 class="text-sm font-medium text-blue-900">Conseils pour un profil complet</h3>
          <div class="mt-2 text-sm text-blue-800">
            <ul class="list-disc list-inside space-y-1">
              <li>Ajoutez une photo de profil professionnelle</li>
              <li>Renseignez vos coordonnées pour faciliter la communication</li>
              <li>Activez les notifications pour ne rien manquer</li>
              <li>Votre adresse aide à personnaliser nos services</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const fileInput = document.getElementById('{{ form.avatar.id_for_label }}');
    const dropzone = document.getElementById('avatar-dropzone');
    const preview = document.getElementById('avatar-preview');
    const fileNameLabel = document.getElementById('avatar-file-name');

    function validateFile(file){
      if(!file.type.startsWith('image/')){ toast('Fichier non supporté','error'); if(fileInput) fileInput.value=''; return false; }
      if(file.size > 2097152){ toast('Fichier trop volumineux (max 2MB)','error'); if(fileInput) fileInput.value=''; return false; }
      return true;
    }

    function updatePreview(file){
      const reader = new FileReader();
      reader.onload = e => {
        if(preview.tagName === 'IMG'){
          preview.src = e.target.result;
        } else {
          const img = document.createElement('img');
            img.id = 'avatar-preview';
            img.className = 'avatar-preview h-24 w-24 rounded-full object-cover border-4 border-gray-200 shadow';
            img.src = e.target.result;
            img.alt = '{{ user.get_full_name }}';
            preview.parentNode.replaceChild(img, preview);
        }
      };
      reader.readAsDataURL(file);
    }

    function handleFiles(files){
      if(!files || !files.length) return;
      const file = files[0];
      if(!validateFile(file)) return;
      fileNameLabel.textContent = file.name;
      updatePreview(file);
    }

    if(fileInput){
      // Garantir accept correto
      fileInput.setAttribute('accept','image/*');
      fileInput.addEventListener('change', e => handleFiles(e.target.files));
    }

    // Drag & Drop
    if(dropzone){
      ['dragenter','dragover'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('border-blue-400','bg-blue-50'); });
      });
      ['dragleave','drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('border-blue-400','bg-blue-50'); });
      });
      dropzone.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        if(dt && dt.files){
          fileInput.files = dt.files; // atribui arquivos
          handleFiles(dt.files);
        }
      });
    }

    // Toast simples reutilizável
    function toast(msg,type='info'){
      const existing = document.getElementById('simple-toast');
      if(existing) existing.remove();
      const colors = {success:'bg-green-600', error:'bg-red-600', info:'bg-blue-600'};
      const div = document.createElement('div');
      div.id='simple-toast';
      div.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm shadow-lg ${colors[type]||colors.info} animate-fade`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(()=>{ div.classList.add('opacity-0'); setTimeout(()=>div.remove(),300); },3000);
    }

    // Submissão (já existente) + melhorias
    const form = document.querySelector('form');
    const submitButton = document.getElementById('submit-button');
    if(form && submitButton){
      form.addEventListener('submit', ()=>{
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';
      });
    }
  });
</script>
{% endblock %}
